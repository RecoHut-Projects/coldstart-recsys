
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MetaTL for Cold-start users on Amazon Electronics dataset &#8212; coldstart-recsys</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="TaNP Cold-start Recommender on LastFM dataset" href="T722684_TaNP_Cold_start_Recommender_on_LastFM_dataset.html" />
    <link rel="prev" title="DropoutNet Cold-start Recommendation on CiteULike dataset" href="T951866_DropoutNet_Cold_start_Recommendation_on_CiteULike_dataset.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">coldstart-recsys</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="L281872_Cold_Start_Recommendations.html">
   Cold-Start Recommendations
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Tutorials
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="T847725_Attribute_to_Feature_Mappings_for_Cold_Start_Recommendations.html">
   Attribute to Feature Mappings for Cold-Start Recommendations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T457846_LightFM_Cold_start_on_ML_10m.html">
   LightFM Cold-start on ML-10m
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T459379_EMCDR_on_MovieLens_Netflix_dataset.html">
   EMCDR on MovieLens-Netflix dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T229879_HERS_Cold_start_Recommendations_on_LastFM_dataset.html">
   HERS Cold-start Recommendations on LastFM dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T316836_Collective_Matrix_Factorization_on_ML_1m.html">
   Collective Matrix Factorization on ML-1m
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T490340_Double_domain_recommendations_on_ML_1m.html">
   Double domain recommendations on ML-1m
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T951866_DropoutNet_Cold_start_Recommendation_on_CiteULike_dataset.html">
   DropoutNet Cold-start Recommendation on CiteULike dataset
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   MetaTL for Cold-start users on Amazon Electronics dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T722684_TaNP_Cold_start_Recommender_on_LastFM_dataset.html">
   TaNP Cold-start Recommender on LastFM dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T290734_AGGN_Cold_start_Recommendation_on_ML_100k.html">
   AGGN Cold-start Recommendation on ML-100k
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T519611_DaRE_Cross_domain_recommender_on_Amazon_Reviews_dataset.html">
   DaRE Cross-domain recommender on Amazon Reviews dataset
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/T714933_MetaTL_for_Cold_start_users_on_Amazon_Electronics_dataset.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/sparsh-ai/coldstart-recsys/main?urlpath=tree/docs/T714933_MetaTL_for_Cold_start_users_on_Amazon_Electronics_dataset.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/sparsh-ai/coldstart-recsys/blob/main/docs/T714933_MetaTL_for_Cold_start_users_on_Amazon_Electronics_dataset.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#background">
   Background
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sequential-recommenders">
     Sequential Recommenders
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#meta-learning">
     Meta Learning
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cold-start-meta-recommenders">
     Cold-Start Meta Recommenders
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cold-start-meta-sequential-recommenders">
     Cold-Start Meta Sequential Recommenders
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#problem-statement">
   Problem Statement
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports">
     Imports
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#params">
     Params
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dataset">
   Dataset
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sampling">
   Sampling
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-definition">
   Model Definition
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#training-and-inference">
   Training and Inference
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#citations">
   Citations
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="metatl-for-cold-start-users-on-amazon-electronics-dataset">
<h1>MetaTL for Cold-start users on Amazon Electronics dataset<a class="headerlink" href="#metatl-for-cold-start-users-on-amazon-electronics-dataset" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>A fundamental challenge for sequential recommenders is to capture the sequential patterns of users toward modeling how users transit among items. In many practical scenarios, however, there are a great number of cold-start users with only minimal logged interactions. As a result, existing sequential recommendation models will lose their predictive power due to the difficulties in learning sequential patterns over users with only limited interactions. In this work, we aim to improve sequential recommendation for cold-start users with a novel framework named MetaTL, which learns to model the transition patterns of users through meta-learning.</p>
<p>Specifically, the proposed MetaTL:</p>
<ol class="simple">
<li><p>formulates sequential recommendation for cold-start users as a few-shot learning problem;</p></li>
<li><p>extracts the dynamic transition patterns among users with a translation-based architecture; and</p></li>
<li><p>adopts meta transitional learning to enable fast learning for cold-start users with only limited interactions, leading to accurate inference of sequential interactions.</p></li>
</ol>
</div>
<div class="section" id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<div class="section" id="sequential-recommenders">
<h3>Sequential Recommenders<a class="headerlink" href="#sequential-recommenders" title="Permalink to this headline">¶</a></h3>
<p>One of the first approaches for sequential recommendation is the use of Markov Chains to model the transitions of users among items. More recently, TransRec embeds items in a “transition space” and learns a translation vector for each user. With the advance in neural networks, many different neural structures including Recurrent Neural Networks, Convolutional Neural Networks, Transformers and Graph Neural Networks, have been adopted to model the dynamic preferences of users over their behavior sequences. While these methods aim to improve the overall performance via representation learning for sequences, they suffer from weak prediction power for cold-start users with short behavior sequences.</p>
</div>
<div class="section" id="meta-learning">
<h3>Meta Learning<a class="headerlink" href="#meta-learning" title="Permalink to this headline">¶</a></h3>
<p>This line of research aims to learn a model which can adapt and generalize to new tasks and new environments with a few training samples. To achieve the goal of “learning-to-learn”, there are three types of different approaches. Metric-based methods are based on a similar idea to the nearest neighbors algorithm with a well-designed metric or distance function, prototypical networks or Siamese Neural Network. Model-based methods usually perform a rapid parameter update with an internal architecture or are controlled by another meta-learner model. As for the optimization-based approaches, by adjusting the optimization algorithm, the models can be efficiently updated with a few examples.</p>
</div>
<div class="section" id="cold-start-meta-recommenders">
<h3>Cold-Start Meta Recommenders<a class="headerlink" href="#cold-start-meta-recommenders" title="Permalink to this headline">¶</a></h3>
<p>MetaRec proposes a meta-learning strategy to learn user-specific logistic regression. There are also methods including MetaCF, Warm-up and MeLU, adopting Model-Agnostic Meta-Learning (MAML) methods to learn a model to achieve fast adaptation for cold-start users.</p>
</div>
<div class="section" id="cold-start-meta-sequential-recommenders">
<h3>Cold-Start Meta Sequential Recommenders<a class="headerlink" href="#cold-start-meta-sequential-recommenders" title="Permalink to this headline">¶</a></h3>
<p>cold-start sequential recommendation targets a setting where no additional auxiliary knowledge can be accessed due to privacy issues, and more importantly, the user-item interactions are sequentially dependent. A user’s preferences and tastes may change over time and such dynamics are of great significance in sequential recommendation. Hence, it is necessary to develop a new sequential recommendation framework that can distill short-range item transitional dynamics, and make fast adaptation to those cold-start users with limited user-item interactions.</p>
</div>
</div>
<div class="section" id="problem-statement">
<h2>Problem Statement<a class="headerlink" href="#problem-statement" title="Permalink to this headline">¶</a></h2>
<p>Let <span class="math notranslate nohighlight">\(I = \{𝑖_1,𝑖_2, \dots,𝑖_𝑃\}\)</span> and <span class="math notranslate nohighlight">\(U = \{u_1,u_2, \dots,u_G\}\)</span> represent the item set and user set in the platform respectively. Each item is mapped to a trainable embedding associated with its ID. There is no auxiliary information for users or items. In sequential recommendation, given the sequence of items <span class="math notranslate nohighlight">\({𝑆𝑒𝑞}_𝑢 = (𝑖_{𝑢,1},𝑖_{𝑢,2}, \dots,𝑖_{𝑢,𝑛})\)</span> that user 𝑢 has interacted with in chronological order, the model aims to infer the next interesting item <span class="math notranslate nohighlight">\(𝑖_{𝑢,𝑛+1}\)</span>. That is to say, we need to predict the preference score for each candidate item based on <span class="math notranslate nohighlight">\({𝑆𝑒𝑞}_𝑢\)</span> and thus recommend the top-N items with the highest scores.</p>
<p>In our task, we train the model on <span class="math notranslate nohighlight">\(U_{𝑡𝑟𝑎𝑖𝑛}\)</span>, which contains users with various numbers of logged interactions. Then given 𝑢 in a separate test set <span class="math notranslate nohighlight">\(U_{𝑡𝑒𝑠𝑡},\ U_{𝑡𝑟𝑎𝑖𝑛} ∩ U_{𝑡𝑒𝑠𝑡} = \phi\)</span>, the model can quickly learn user transition patterns according to the 𝐾 initial interactions and thus infer the sequential interactions. Note that the size of a user’s initial interactions (i.e., 𝐾) is assumed to be a small number (e.g., 2, 3 or 4) considering the cold-start scenario.</p>
</div>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<div class="section" id="imports">
<h3>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="params">
<h3>Params<a class="headerlink" href="#params" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Args</span><span class="p">:</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="s2">&quot;electronics&quot;</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">K</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1">#NUMBER OF SHOT</span>
    <span class="n">embed_dim</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1024</span>
    <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">print_epoch</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">eval_epoch</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">margin</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">dropout_p</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">Args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="n">params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;K&#39;: 3,
 &#39;__dict__&#39;: &lt;attribute &#39;__dict__&#39; of &#39;Args&#39; objects&gt;,
 &#39;__doc__&#39;: None,
 &#39;__module__&#39;: &#39;__main__&#39;,
 &#39;__weakref__&#39;: &lt;attribute &#39;__weakref__&#39; of &#39;Args&#39; objects&gt;,
 &#39;batch_size&#39;: 1024,
 &#39;beta&#39;: 5,
 &#39;dataset&#39;: &#39;electronics&#39;,
 &#39;device&#39;: device(type=&#39;cuda&#39;, index=0),
 &#39;dropout_p&#39;: 0.5,
 &#39;embed_dim&#39;: 100,
 &#39;epoch&#39;: 1000,
 &#39;eval_epoch&#39;: 100,
 &#39;learning_rate&#39;: 0.001,
 &#39;margin&#39;: 1,
 &#39;print_epoch&#39;: 100,
 &#39;seed&#39;: None}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">SEED</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="dataset">
<h2>Dataset<a class="headerlink" href="#dataset" title="Permalink to this headline">¶</a></h2>
<p><em><strong>Electronics</strong></em> is adopted from the public Amazon review dataset, which includes reviews ranging from May 1996 to July 2014 on Amazon products belonging to the “Electronics” category.</p>
<p>We filter out items with fewer than 10 interactions. We split each dataset with a corresponding cutting timestamp 𝑇, such that we construct <span class="math notranslate nohighlight">\(U_{𝑡𝑟𝑎𝑖𝑛}\)</span> with users who have interactions before 𝑇 and construct <span class="math notranslate nohighlight">\(U_{𝑡𝑒𝑠𝑡}\)</span> with users who start their first interactions after 𝑇.</p>
<p>When evaluating few-shot sequential recommendation for a choice of 𝐾 (i.e., the number of initial interactions), we keep 𝐾 interactions as initialization for each user in <span class="math notranslate nohighlight">\(U_{𝑡𝑒𝑠𝑡}\)</span> and predict for the user’s next interactions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!wget -q --show-progress https://github.com/sparsh-ai/coldstart-recsys/raw/main/data/electronics/electronics_train.csv
!wget -q --show-progress https://github.com/sparsh-ai/coldstart-recsys/raw/main/data/electronics/electronics_test_new_user.csv
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>electronics_train.c 100%[===================&gt;]   7.41M  --.-KB/s    in 0.1s    
electronics_test_ne 100%[===================&gt;] 892.31K  --.-KB/s    in 0.06s   
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># sampler for batch generation</span>
<span class="k">def</span> <span class="nf">random_neq</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">trans_to_cuda</span><span class="p">(</span><span class="n">variable</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">variable</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">variable</span>


<span class="k">def</span> <span class="nf">trans_to_cpu</span><span class="p">(</span><span class="n">variable</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">variable</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">variable</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># train/val/test data generation</span>
<span class="k">def</span> <span class="nf">data_load</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">num_sample</span><span class="p">):</span>
    <span class="n">usernum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">itemnum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">user_train</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="c1"># assume user/item index starting from 1</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_train.csv&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">usernum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">usernum</span><span class="p">)</span>
        <span class="n">itemnum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">itemnum</span><span class="p">)</span>
        <span class="n">user_train</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># read in new users for testing</span>
    <span class="n">user_input_test</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">user_input_valid</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">user_valid</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">user_test</span> <span class="o">=</span> <span class="p">{}</span>


    <span class="n">User_test_new</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_test_new_user.csv&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">User_test_new</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">User_test_new</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">User_test_new</span><span class="p">[</span><span class="n">user</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">num_sample</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">&lt;</span><span class="mf">0.3</span><span class="p">:</span>
                <span class="n">user_input_valid</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="n">User_test_new</span><span class="p">[</span><span class="n">user</span><span class="p">][:</span><span class="n">num_sample</span><span class="p">]</span>
                <span class="n">user_valid</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">user_valid</span><span class="p">[</span><span class="n">user</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">User_test_new</span><span class="p">[</span><span class="n">user</span><span class="p">][</span><span class="n">num_sample</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">user_input_test</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="n">User_test_new</span><span class="p">[</span><span class="n">user</span><span class="p">][:</span><span class="n">num_sample</span><span class="p">]</span>
                <span class="n">user_test</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">user_test</span><span class="p">[</span><span class="n">user</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">User_test_new</span><span class="p">[</span><span class="n">user</span><span class="p">][</span><span class="n">num_sample</span><span class="p">])</span>
    

    <span class="k">return</span> <span class="p">[</span><span class="n">user_train</span><span class="p">,</span> <span class="n">usernum</span><span class="p">,</span> <span class="n">itemnum</span><span class="p">,</span> <span class="n">user_input_test</span><span class="p">,</span> <span class="n">user_test</span><span class="p">,</span> <span class="n">user_input_valid</span><span class="p">,</span> <span class="n">user_valid</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_train</span><span class="p">,</span> <span class="n">user_test</span><span class="p">,</span> <span class="n">itemnum</span><span class="p">,</span> <span class="n">parameter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_rel_idx</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">bs</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">valid_user</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">user_train</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_train</span><span class="p">[</span><span class="n">u</span><span class="p">])</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_test</span><span class="p">[</span><span class="n">u</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid_user</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">num_tris</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_user</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="o">=</span> <span class="n">user_train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">user_test</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">itemnum</span> <span class="o">=</span> <span class="n">itemnum</span>

    <span class="k">def</span> <span class="nf">next_one_on_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_tri_idx</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_tris</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;EOT&quot;</span><span class="p">,</span> <span class="s2">&quot;EOT&quot;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_user</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_tri_idx</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">curr_tri_idx</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">ts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">[</span><span class="n">u</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">[</span><span class="n">u</span><span class="p">]):</span>
            <span class="n">seq</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pos</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">neg</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_neq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">break</span>

        <span class="n">curr_rel</span> <span class="o">=</span> <span class="n">u</span>
        <span class="n">support_triples</span><span class="p">,</span> <span class="n">support_negative_triples</span><span class="p">,</span> <span class="n">query_triples</span><span class="p">,</span> <span class="n">negative_triples</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">support_triples</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">seq</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">curr_rel</span><span class="p">,</span><span class="n">pos</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>
            <span class="n">support_negative_triples</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">seq</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">curr_rel</span><span class="p">,</span><span class="n">neg</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>

        <span class="n">rated</span> <span class="o">=</span> <span class="n">ts</span>
        <span class="n">rated</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">query_triples</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">seq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">curr_rel</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">rated</span><span class="p">:</span> <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">negative_triples</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">seq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">curr_rel</span><span class="p">,</span><span class="n">t</span><span class="p">])</span>

        <span class="n">support_triples</span> <span class="o">=</span> <span class="p">[</span><span class="n">support_triples</span><span class="p">]</span>
        <span class="n">support_negative_triples</span> <span class="o">=</span> <span class="p">[</span><span class="n">support_negative_triples</span><span class="p">]</span>
        <span class="n">query_triples</span> <span class="o">=</span> <span class="p">[</span><span class="n">query_triples</span><span class="p">]</span>
        <span class="n">negative_triples</span> <span class="o">=</span> <span class="p">[</span><span class="n">negative_triples</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">support_triples</span><span class="p">,</span> <span class="n">support_negative_triples</span><span class="p">,</span> <span class="n">query_triples</span><span class="p">,</span> <span class="n">negative_triples</span><span class="p">],</span> <span class="n">curr_rel</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="sampling">
<h2>Sampling<a class="headerlink" href="#sampling" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sample_function_mixed</span><span class="p">(</span><span class="n">user_train</span><span class="p">,</span> <span class="n">usernum</span><span class="p">,</span> <span class="n">itemnum</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">,</span> <span class="n">result_queue</span><span class="p">,</span> <span class="n">SEED</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">sample</span><span class="p">():</span>

        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">usernum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_train</span><span class="p">[</span><span class="n">user</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span> <span class="n">user</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">usernum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            
            <span class="n">seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">maxlen</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">maxlen</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">maxlen</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_train</span><span class="p">[</span><span class="n">user</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">maxlen</span><span class="p">:</span>
                <span class="n">nxt_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_train</span><span class="p">[</span><span class="n">user</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nxt_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">maxlen</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">user_train</span><span class="p">[</span><span class="n">user</span><span class="p">]))</span>

            <span class="n">nxt</span> <span class="o">=</span> <span class="n">user_train</span><span class="p">[</span><span class="n">user</span><span class="p">][</span><span class="n">nxt_idx</span><span class="p">]</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">maxlen</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="n">ts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">user_train</span><span class="p">[</span><span class="n">user</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">user_train</span><span class="p">[</span><span class="n">user</span><span class="p">][</span><span class="nb">min</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nxt_idx</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">maxlen</span><span class="p">)</span> <span class="p">:</span> <span class="n">nxt_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]):</span>
                <span class="n">seq</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">pos</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">nxt</span>
                <span class="k">if</span> <span class="n">nxt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">neg</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_neq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">itemnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
                <span class="n">nxt</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">idx</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">break</span>

            <span class="n">curr_rel</span> <span class="o">=</span> <span class="n">user</span>
            <span class="n">support_triples</span><span class="p">,</span> <span class="n">support_negative_triples</span><span class="p">,</span> <span class="n">query_triples</span><span class="p">,</span> <span class="n">negative_triples</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxlen</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">support_triples</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">seq</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">curr_rel</span><span class="p">,</span><span class="n">pos</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>
                <span class="n">support_negative_triples</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">seq</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">curr_rel</span><span class="p">,</span><span class="n">neg</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>
            <span class="n">query_triples</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">seq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">curr_rel</span><span class="p">,</span><span class="n">pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">negative_triples</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">seq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">curr_rel</span><span class="p">,</span><span class="n">neg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

            <span class="k">return</span> <span class="n">support_triples</span><span class="p">,</span> <span class="n">support_negative_triples</span><span class="p">,</span> <span class="n">query_triples</span><span class="p">,</span> <span class="n">negative_triples</span><span class="p">,</span> <span class="n">curr_rel</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">usernum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_train</span><span class="p">[</span><span class="n">user</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span> <span class="n">user</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">usernum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">maxlen</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">maxlen</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">maxlen</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

            <span class="n">list_idx</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">user_train</span><span class="p">[</span><span class="n">user</span><span class="p">]))],</span> <span class="n">maxlen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">list_item</span> <span class="o">=</span> <span class="p">[</span><span class="n">user_train</span><span class="p">[</span><span class="n">user</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">list_idx</span><span class="p">)]</span>

            <span class="n">nxt</span> <span class="o">=</span> <span class="n">list_item</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">maxlen</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="n">ts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">user_train</span><span class="p">[</span><span class="n">user</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">list_item</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">seq</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">pos</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">nxt</span>
                <span class="k">if</span> <span class="n">nxt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="n">neg</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_neq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">itemnum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ts</span><span class="p">)</span>
                <span class="n">nxt</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">idx</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">break</span>

            <span class="n">curr_rel</span> <span class="o">=</span> <span class="n">user</span>
            <span class="n">support_triples</span><span class="p">,</span> <span class="n">support_negative_triples</span><span class="p">,</span> <span class="n">query_triples</span><span class="p">,</span> <span class="n">negative_triples</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxlen</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">support_triples</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">seq</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">curr_rel</span><span class="p">,</span><span class="n">pos</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>
                <span class="n">support_negative_triples</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">seq</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">curr_rel</span><span class="p">,</span><span class="n">neg</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>
            <span class="n">query_triples</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">seq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">curr_rel</span><span class="p">,</span><span class="n">pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">negative_triples</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">seq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">curr_rel</span><span class="p">,</span><span class="n">neg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

            <span class="k">return</span> <span class="n">support_triples</span><span class="p">,</span> <span class="n">support_negative_triples</span><span class="p">,</span> <span class="n">query_triples</span><span class="p">,</span> <span class="n">negative_triples</span><span class="p">,</span> <span class="n">curr_rel</span>

    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">SEED</span><span class="p">)</span>
    
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">one_batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">one_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">())</span>

        <span class="n">support</span><span class="p">,</span> <span class="n">support_negative</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">negative</span><span class="p">,</span> <span class="n">curr_rel</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">one_batch</span><span class="p">)</span>

        <span class="n">result_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(([</span><span class="n">support</span><span class="p">,</span> <span class="n">support_negative</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">negative</span><span class="p">],</span> <span class="n">curr_rel</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">WarpSampler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">User</span><span class="p">,</span> <span class="n">usernum</span><span class="p">,</span> <span class="n">itemnum</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">n_workers</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_workers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">sample_function_mixed</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">User</span><span class="p">,</span>
                                                      <span class="n">usernum</span><span class="p">,</span>
                                                      <span class="n">itemnum</span><span class="p">,</span>
                                                      <span class="n">batch_size</span><span class="p">,</span>
                                                      <span class="n">maxlen</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">result_queue</span><span class="p">,</span>
                                                      <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mf">2e9</span><span class="p">)</span>
                                                      <span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">next_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processors</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="model-definition">
<h2>Model Definition<a class="headerlink" href="#model-definition" title="Permalink to this headline">¶</a></h2>
<p><center><img src='_images/T714933_1.png'></center></p><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Embedding</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_ent</span><span class="p">,</span> <span class="n">parameter</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Embedding</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">es</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;embed_dim&#39;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_ent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">es</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triples</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">[[[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">]</span> <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">triples</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MetaLearner</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">embed_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">num_hidden1</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_hidden2</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">out_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">dropout_p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MetaLearner</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span> <span class="o">=</span> <span class="n">embed_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_size</span> <span class="o">=</span> <span class="n">out_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;fc&#39;</span><span class="p">,</span>   <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">embed_size</span><span class="p">,</span> <span class="n">num_hidden1</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;bn&#39;</span><span class="p">,</span>   <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">K</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()),</span>
            <span class="p">(</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout_p</span><span class="p">)),</span>
        <span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;fc&#39;</span><span class="p">,</span>   <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">num_hidden1</span><span class="p">,</span> <span class="n">num_hidden2</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;bn&#39;</span><span class="p">,</span>   <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">K</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">()),</span>
            <span class="p">(</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">dropout_p</span><span class="p">)),</span>
        <span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_fc3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;fc&#39;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">num_hidden2</span><span class="p">,</span> <span class="n">out_size</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;bn&#39;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">K</span><span class="p">)),</span>
        <span class="p">]))</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_fc1</span><span class="o">.</span><span class="n">fc</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_fc2</span><span class="o">.</span><span class="n">fc</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_normal_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_fc3</span><span class="o">.</span><span class="n">fc</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_fc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_fc2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_fc3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">EmbeddingLearner</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EmbeddingLearner</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">pos_num</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">r</span> <span class="o">-</span> <span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">p_score</span> <span class="o">=</span> <span class="n">score</span><span class="p">[:,</span> <span class="p">:</span><span class="n">pos_num</span><span class="p">]</span>
        <span class="n">n_score</span> <span class="o">=</span> <span class="n">score</span><span class="p">[:,</span> <span class="n">pos_num</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">p_score</span><span class="p">,</span> <span class="n">n_score</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MetaTL</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itemnum</span><span class="p">,</span> <span class="n">parameter</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MetaTL</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;dropout_p&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embed_dim</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;embed_dim&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;margin&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">Embedding</span><span class="p">(</span><span class="n">itemnum</span><span class="p">,</span> <span class="n">parameter</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">relation_learner</span> <span class="o">=</span> <span class="n">MetaLearner</span><span class="p">(</span><span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">embed_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">num_hidden1</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                                                    <span class="n">num_hidden2</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">out_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">dropout_p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_p</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_learner</span> <span class="o">=</span> <span class="n">EmbeddingLearner</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MarginRankingLoss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_q_sharing</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">split_concat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positive</span><span class="p">,</span> <span class="n">negative</span><span class="p">):</span>
        <span class="n">pos_neg_e1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">positive</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
                                <span class="n">negative</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]],</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pos_neg_e2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">positive</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                                <span class="n">negative</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]],</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pos_neg_e1</span><span class="p">,</span> <span class="n">pos_neg_e2</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">iseval</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">curr_rel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="c1"># transfer task string into embedding</span>
        <span class="n">support</span><span class="p">,</span> <span class="n">support_negative</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">negative</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">task</span><span class="p">]</span>

        <span class="n">K</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>              <span class="c1"># num of K</span>
        <span class="n">num_sn</span> <span class="o">=</span> <span class="n">support_negative</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># num of support negative</span>
        <span class="n">num_q</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>              <span class="c1"># num of query</span>
        <span class="n">num_n</span> <span class="o">=</span> <span class="n">negative</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>           <span class="c1"># num of query negative</span>

        <span class="n">rel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_learner</span><span class="p">(</span><span class="n">support</span><span class="p">)</span>
        <span class="n">rel</span><span class="o">.</span><span class="n">retain_grad</span><span class="p">()</span>

        <span class="n">rel_s</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">K</span><span class="o">+</span><span class="n">num_sn</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">iseval</span> <span class="ow">and</span> <span class="n">curr_rel</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">curr_rel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_q_sharing</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">rel_q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_q_sharing</span><span class="p">[</span><span class="n">curr_rel</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sup_neg_e1</span><span class="p">,</span> <span class="n">sup_neg_e2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_concat</span><span class="p">(</span><span class="n">support</span><span class="p">,</span> <span class="n">support_negative</span><span class="p">)</span>

            <span class="n">p_score</span><span class="p">,</span> <span class="n">n_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_learner</span><span class="p">(</span><span class="n">sup_neg_e1</span><span class="p">,</span> <span class="n">sup_neg_e2</span><span class="p">,</span> <span class="n">rel_s</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>

            <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_func</span><span class="p">(</span><span class="n">p_score</span><span class="p">,</span> <span class="n">n_score</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">grad_meta</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">grad</span>
            <span class="n">rel_q</span> <span class="o">=</span> <span class="n">rel</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="o">*</span><span class="n">grad_meta</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">rel_q_sharing</span><span class="p">[</span><span class="n">curr_rel</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_q</span>

        <span class="n">rel_q</span> <span class="o">=</span> <span class="n">rel_q</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_q</span> <span class="o">+</span> <span class="n">num_n</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">que_neg_e1</span><span class="p">,</span> <span class="n">que_neg_e2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_concat</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">negative</span><span class="p">)</span>  
        <span class="n">p_score</span><span class="p">,</span> <span class="n">n_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_learner</span><span class="p">(</span><span class="n">que_neg_e1</span><span class="p">,</span> <span class="n">que_neg_e2</span><span class="p">,</span> <span class="n">rel_q</span><span class="p">,</span> <span class="n">num_q</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">p_score</span><span class="p">,</span> <span class="n">n_score</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="training-and-inference">
<h2>Training and Inference<a class="headerlink" href="#training-and-inference" title="Permalink to this headline">¶</a></h2>
<p>Meta-learning aims to learn a model which can adapt to new tasks (i.e., new users) with a few training samples. To enable meta-learning in sequential recommendation for cold-start users, we formulate training a sequential recommender as solving a new few-shot learning problem (i.e., meta-testing task) by training on many sampled similar tasks (i.e., the meta-training tasks). Each task includes a 𝑠𝑢𝑝𝑝𝑜𝑟𝑡 set S and a 𝑞𝑢𝑒𝑟𝑦 set Q, which can be regarded as the “training” set and “testing” set of the task. For example, while constructing a task <span class="math notranslate nohighlight">\(T_𝑛\)</span>, given user <span class="math notranslate nohighlight">\(𝑢_𝑗\)</span> with initial interactions in sequence (e.g., <span class="math notranslate nohighlight">\(𝑖_𝐴 \rightarrow_{u_j} i_B \rightarrow_{u_j} i_C\)</span>), we will have the a set of transition pairs <span class="math notranslate nohighlight">\(\{ 𝑖_𝐴 \rightarrow_{u_j} i_B, i_B \rightarrow_{u_j} i_C \}\)</span> as support and predict for the query <span class="math notranslate nohighlight">\(i_C \rightarrow_{u_j} ?\)</span>.</p>
<p>When testing on a new user <span class="math notranslate nohighlight">\(𝑢_{𝑡𝑒𝑠𝑡}\)</span>, we will firstly construct the support set <span class="math notranslate nohighlight">\(S_{𝑡𝑒𝑠𝑡}\)</span> based on the user’s initial interactions. The model <span class="math notranslate nohighlight">\(𝑓_\theta\)</span> is fine-tuned with all the transition pairs in <span class="math notranslate nohighlight">\(S_{𝑡𝑒𝑠𝑡}\)</span> and updated to <span class="math notranslate nohighlight">\(𝑓_{\theta_{𝑡𝑒𝑠𝑡}'}\)</span> , which can be used to generate the updated <span class="math notranslate nohighlight">\(tr_{𝑡𝑒𝑠𝑡}\)</span>. Given the test query <span class="math notranslate nohighlight">\(𝑖_𝑜 \rightarrow_{u_{test}}?\)</span>, the preference score for item <span class="math notranslate nohighlight">\(𝑖_𝑝\)</span> (as the next interaction) is calculated as −<span class="math notranslate nohighlight">\(∥i_𝑜 + tr_{𝑡𝑒𝑠𝑡} − i_𝑝 ∥^2\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Trainer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_loaders</span><span class="p">,</span> <span class="n">itemnum</span><span class="p">,</span> <span class="n">parameter</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span> <span class="o">=</span> <span class="n">parameter</span>
        <span class="c1"># data loader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_data_loader</span> <span class="o">=</span> <span class="n">data_loaders</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev_data_loader</span> <span class="o">=</span> <span class="n">data_loaders</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_data_loader</span> <span class="o">=</span> <span class="n">data_loaders</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_epoch</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;print_epoch&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_epoch</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;eval_epoch&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">MetaTL</span> <span class="o">=</span> <span class="n">MetaTL</span><span class="p">(</span><span class="n">itemnum</span><span class="p">,</span> <span class="n">parameter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MetaTL</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MetaTL</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>

            
    <span class="k">def</span> <span class="nf">rank_predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ranks</span><span class="p">):</span>
        <span class="c1"># query_idx is the idx of positive score</span>
        <span class="n">query_idx</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1"># sort all scores with descending, because more plausible triple has higher score</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">query_idx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ranks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span>
        <span class="c1"># update data</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Hits@10&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;NDCG@10&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Hits@5&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;NDCG@5&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Hits@1&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;NDCG@1&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;MRR&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">rank</span>

    <span class="k">def</span> <span class="nf">do_one_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">iseval</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">curr_rel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">loss</span><span class="p">,</span> <span class="n">p_score</span><span class="p">,</span> <span class="n">n_score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">iseval</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">p_score</span><span class="p">,</span> <span class="n">n_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MetaTL</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">iseval</span><span class="p">,</span> <span class="n">curr_rel</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MetaTL</span><span class="o">.</span><span class="n">loss_func</span><span class="p">(</span><span class="n">p_score</span><span class="p">,</span> <span class="n">n_score</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">curr_rel</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">p_score</span><span class="p">,</span> <span class="n">n_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MetaTL</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">iseval</span><span class="p">,</span> <span class="n">curr_rel</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MetaTL</span><span class="o">.</span><span class="n">loss_func</span><span class="p">(</span><span class="n">p_score</span><span class="p">,</span> <span class="n">n_score</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">p_score</span><span class="p">,</span> <span class="n">n_score</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># initialization</span>
        <span class="n">best_epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">best_value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bad_counts</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># training by epoch</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">):</span>
            <span class="c1"># sample one batch from data_loader</span>
            <span class="n">train_task</span><span class="p">,</span> <span class="n">curr_rel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_data_loader</span><span class="o">.</span><span class="n">next_batch</span><span class="p">()</span>
            <span class="n">loss</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_one_step</span><span class="p">(</span><span class="n">train_task</span><span class="p">,</span> <span class="n">iseval</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">curr_rel</span><span class="o">=</span><span class="n">curr_rel</span><span class="p">)</span>
            <span class="c1"># print the loss on specific epoch</span>
            <span class="k">if</span> <span class="n">e</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">loss_num</span> <span class="o">=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Epoch: </span><span class="si">{}</span><span class="se">\t</span><span class="s2">Loss: </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">loss_num</span><span class="p">))</span>
            <span class="c1"># do evaluation on specific epoch</span>
            <span class="k">if</span> <span class="n">e</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_epoch</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">e</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epoch  </span><span class="si">{}</span><span class="s1"> Validating...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">valid_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">istest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epoch  </span><span class="si">{}</span><span class="s1"> Testing...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">test_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">istest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
                
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finish&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">istest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MetaTL</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">MetaTL</span><span class="o">.</span><span class="n">rel_q_sharing</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
            <span class="n">data_loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_data_loader</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev_data_loader</span>
        <span class="n">data_loader</span><span class="o">.</span><span class="n">curr_tri_idx</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># initial return data of validation</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;MRR&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Hits@1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Hits@5&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Hits@10&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;NDCG@1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;NDCG@5&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;NDCG@10&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="n">ranks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># sample all the eval tasks</span>
            <span class="n">eval_task</span><span class="p">,</span> <span class="n">curr_rel</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">next_one_on_eval</span><span class="p">()</span>
            <span class="c1"># at the end of sample tasks, a symbol &#39;EOT&#39; will return</span>
            <span class="k">if</span> <span class="n">eval_task</span> <span class="o">==</span> <span class="s1">&#39;EOT&#39;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">p_score</span><span class="p">,</span> <span class="n">n_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_one_step</span><span class="p">(</span><span class="n">eval_task</span><span class="p">,</span> <span class="n">iseval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">curr_rel</span><span class="o">=</span><span class="n">curr_rel</span><span class="p">)</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">n_score</span><span class="p">,</span> <span class="n">p_score</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">rank_predict</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ranks</span><span class="p">)</span>

            <span class="c1"># print current temp data dynamically</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">temp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="n">t</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t</span><span class="s2">MRR: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">NDCG@10: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">NDCG@5: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">NDCG@1: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">Hits@10: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">Hits@5: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">Hits@1: </span><span class="si">{:.3f}</span><span class="se">\r</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;MRR&#39;</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;NDCG@10&#39;</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;NDCG@5&#39;</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;NDCG@1&#39;</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;Hits@10&#39;</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;Hits@5&#39;</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;Hits@1&#39;</span><span class="p">]))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># print overall evaluation result and return it</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="n">t</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        
        <span class="k">if</span> <span class="n">istest</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TEST: </span><span class="se">\t</span><span class="s2">MRR: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">NDCG@10: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">NDCG@5: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">NDCG@1: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">Hits@10: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">Hits@5: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">Hits@1: </span><span class="si">{:.3f}</span><span class="se">\r</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;MRR&#39;</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;NDCG@10&#39;</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;NDCG@5&#39;</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;NDCG@1&#39;</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;Hits@10&#39;</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;Hits@5&#39;</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;Hits@1&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;VALID: </span><span class="se">\t</span><span class="s2">MRR: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">NDCG@10: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">NDCG@5: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">NDCG@1: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">Hits@10: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">Hits@5: </span><span class="si">{:.3f}</span><span class="se">\t</span><span class="s2">Hits@1: </span><span class="si">{:.3f}</span><span class="se">\r</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;MRR&#39;</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;NDCG@10&#39;</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;NDCG@5&#39;</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;NDCG@1&#39;</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;Hits@10&#39;</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;Hits@5&#39;</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;Hits@1&#39;</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">user_train</span><span class="p">,</span> <span class="n">usernum_train</span><span class="p">,</span> <span class="n">itemnum</span><span class="p">,</span> <span class="n">user_input_test</span><span class="p">,</span> <span class="n">user_test</span><span class="p">,</span> <span class="n">user_input_valid</span><span class="p">,</span> <span class="n">user_valid</span> <span class="o">=</span> <span class="n">data_load</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">])</span>    

<span class="n">sampler</span> <span class="o">=</span> <span class="n">WarpSampler</span><span class="p">(</span><span class="n">user_train</span><span class="p">,</span> <span class="n">usernum_train</span><span class="p">,</span> <span class="n">itemnum</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">],</span> <span class="n">maxlen</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">],</span> <span class="n">n_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">sampler_test</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">user_input_test</span><span class="p">,</span> <span class="n">user_test</span><span class="p">,</span> <span class="n">itemnum</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<span class="n">sampler_valid</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">user_input_valid</span><span class="p">,</span> <span class="n">user_valid</span><span class="p">,</span> <span class="n">itemnum</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">([</span><span class="n">sampler</span><span class="p">,</span> <span class="n">sampler_valid</span><span class="p">,</span> <span class="n">sampler_test</span><span class="p">],</span> <span class="n">itemnum</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

<span class="n">sampler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 0	Loss: 1.0004
Epoch: 100	Loss: 0.7276
Epoch: 200	Loss: 0.6102
Epoch: 300	Loss: 0.6143
Epoch: 400	Loss: 0.5779
Epoch: 500	Loss: 0.5438
Epoch: 600	Loss: 0.5271
Epoch: 700	Loss: 0.5430
Epoch: 800	Loss: 0.5642
Epoch: 900	Loss: 0.5107
Epoch: 1000	Loss: 0.5222
Epoch  1000 Validating...
VALID: 	MRR: 0.302	NDCG@10: 0.345	NDCG@5: 0.303	NDCG@1: 0.187	Hits@10: 0.542	Hits@5: 0.410	Hits@1: 0.187
Epoch  1000 Testing...
TEST: 	MRR: 0.286	NDCG@10: 0.327	NDCG@5: 0.286	NDCG@1: 0.172	Hits@10: 0.523	Hits@5: 0.397	Hits@1: 0.172
Epoch: 1100	Loss: 0.5396
Epoch: 1200	Loss: 0.5236
Epoch: 1300	Loss: 0.4934
Epoch: 1400	Loss: 0.4948
Epoch: 1500	Loss: 0.5047
Epoch: 1600	Loss: 0.4933
Epoch: 1700	Loss: 0.5068
Epoch: 1800	Loss: 0.4833
Epoch: 1900	Loss: 0.5245
Epoch: 2000	Loss: 0.4982
Epoch  2000 Validating...
VALID: 	MRR: 0.307	NDCG@10: 0.353	NDCG@5: 0.308	NDCG@1: 0.188	Hits@10: 0.561	Hits@5: 0.422	Hits@1: 0.188
Epoch  2000 Testing...
TEST: 	MRR: 0.295	NDCG@10: 0.338	NDCG@5: 0.296	NDCG@1: 0.177	Hits@10: 0.538	Hits@5: 0.406	Hits@1: 0.177
Epoch: 2100	Loss: 0.4960
Epoch: 2200	Loss: 0.4943
Epoch: 2300	Loss: 0.4477
Epoch: 2400	Loss: 0.4481
Epoch: 2500	Loss: 0.4429
Epoch: 2600	Loss: 0.4885
Epoch: 2700	Loss: 0.4485
Epoch: 2800	Loss: 0.4438
Epoch: 2900	Loss: 0.4456
Epoch: 3000	Loss: 0.4484
Epoch  3000 Validating...
VALID: 	MRR: 0.317	NDCG@10: 0.360	NDCG@5: 0.317	NDCG@1: 0.197	Hits@10: 0.558	Hits@5: 0.425	Hits@1: 0.197
Epoch  3000 Testing...
TEST: 	MRR: 0.302	NDCG@10: 0.347	NDCG@5: 0.304	NDCG@1: 0.182	Hits@10: 0.551	Hits@5: 0.418	Hits@1: 0.182
Epoch: 3100	Loss: 0.4422
Epoch: 3200	Loss: 0.4398
Epoch: 3300	Loss: 0.4230
Epoch: 3400	Loss: 0.3967
Epoch: 3500	Loss: 0.4214
Epoch: 3600	Loss: 0.4144
Epoch: 3700	Loss: 0.3635
Epoch: 3800	Loss: 0.3918
Epoch: 3900	Loss: 0.4223
Epoch: 4000	Loss: 0.4319
Epoch  4000 Validating...
VALID: 	MRR: 0.322	NDCG@10: 0.371	NDCG@5: 0.326	NDCG@1: 0.195	Hits@10: 0.584	Hits@5: 0.445	Hits@1: 0.195
Epoch  4000 Testing...
TEST: 	MRR: 0.309	NDCG@10: 0.357	NDCG@5: 0.310	NDCG@1: 0.189	Hits@10: 0.567	Hits@5: 0.423	Hits@1: 0.189
Epoch: 4100	Loss: 0.3717
Epoch: 4200	Loss: 0.3762
Epoch: 4300	Loss: 0.3786
Epoch: 4400	Loss: 0.3803
Epoch: 4500	Loss: 0.3884
Epoch: 4600	Loss: 0.3833
Epoch: 4700	Loss: 0.3913
Epoch: 4800	Loss: 0.4011
Epoch: 4900	Loss: 0.3760
Epoch: 5000	Loss: 0.4257
Epoch  5000 Validating...
VALID: 	MRR: 0.329	NDCG@10: 0.378	NDCG@5: 0.336	NDCG@1: 0.200	Hits@10: 0.591	Hits@5: 0.462	Hits@1: 0.200
Epoch  5000 Testing...
TEST: 	MRR: 0.321	NDCG@10: 0.367	NDCG@5: 0.322	NDCG@1: 0.201	Hits@10: 0.575	Hits@5: 0.435	Hits@1: 0.201
Epoch: 5100	Loss: 0.3676
Epoch: 5200	Loss: 0.3505
Epoch: 5300	Loss: 0.3675
Epoch: 5400	Loss: 0.3786
Epoch: 5500	Loss: 0.3471
Epoch: 5600	Loss: 0.3569
Epoch: 5700	Loss: 0.3753
Epoch: 5800	Loss: 0.3767
Epoch: 5900	Loss: 0.3100
Epoch: 6000	Loss: 0.3656
Epoch  6000 Validating...
VALID: 	MRR: 0.343	NDCG@10: 0.392	NDCG@5: 0.351	NDCG@1: 0.216	Hits@10: 0.607	Hits@5: 0.479	Hits@1: 0.216
Epoch  6000 Testing...
TEST: 	MRR: 0.329	NDCG@10: 0.377	NDCG@5: 0.334	NDCG@1: 0.207	Hits@10: 0.585	Hits@5: 0.452	Hits@1: 0.207
Epoch: 6100	Loss: 0.3711
Epoch: 6200	Loss: 0.3548
Epoch: 6300	Loss: 0.3829
Epoch: 6400	Loss: 0.3478
Epoch: 6500	Loss: 0.3661
Epoch: 6600	Loss: 0.3433
Epoch: 6700	Loss: 0.3506
Epoch: 6800	Loss: 0.3107
Epoch: 6900	Loss: 0.3364
Epoch: 7000	Loss: 0.3267
Epoch  7000 Validating...
VALID: 	MRR: 0.344	NDCG@10: 0.395	NDCG@5: 0.351	NDCG@1: 0.216	Hits@10: 0.615	Hits@5: 0.479	Hits@1: 0.216
Epoch  7000 Testing...
TEST: 	MRR: 0.329	NDCG@10: 0.378	NDCG@5: 0.335	NDCG@1: 0.204	Hits@10: 0.588	Hits@5: 0.458	Hits@1: 0.204
Epoch: 7100	Loss: 0.3744
Epoch: 7200	Loss: 0.3236
Epoch: 7300	Loss: 0.3446
Epoch: 7400	Loss: 0.3261
Epoch: 7500	Loss: 0.3212
Epoch: 7600	Loss: 0.3229
Epoch: 7700	Loss: 0.3204
Epoch: 7800	Loss: 0.3168
Epoch: 7900	Loss: 0.3125
Epoch: 8000	Loss: 0.3491
Epoch  8000 Validating...
VALID: 	MRR: 0.349	NDCG@10: 0.398	NDCG@5: 0.354	NDCG@1: 0.228	Hits@10: 0.611	Hits@5: 0.473	Hits@1: 0.228
Epoch  8000 Testing...
TEST: 	MRR: 0.326	NDCG@10: 0.375	NDCG@5: 0.333	NDCG@1: 0.197	Hits@10: 0.588	Hits@5: 0.457	Hits@1: 0.197
Epoch: 8100	Loss: 0.3372
Epoch: 8200	Loss: 0.3157
Epoch: 8300	Loss: 0.3285
Epoch: 8400	Loss: 0.3266
Epoch: 8500	Loss: 0.3086
Epoch: 8600	Loss: 0.3008
Epoch: 8700	Loss: 0.3207
Epoch: 8800	Loss: 0.3412
Epoch: 8900	Loss: 0.3214
Epoch: 9000	Loss: 0.3146
Epoch  9000 Validating...
VALID: 	MRR: 0.351	NDCG@10: 0.401	NDCG@5: 0.355	NDCG@1: 0.229	Hits@10: 0.615	Hits@5: 0.474	Hits@1: 0.229
Epoch  9000 Testing...
TEST: 	MRR: 0.336	NDCG@10: 0.383	NDCG@5: 0.341	NDCG@1: 0.214	Hits@10: 0.588	Hits@5: 0.458	Hits@1: 0.214
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="citations">
<h2>Citations<a class="headerlink" href="#citations" title="Permalink to this headline">¶</a></h2>
<p>Sequential Recommendation for Cold-start Users with Meta Transitional Learning. Jianling Wang, Kaize Ding, James Caverlee. 2021. SIGIR. <a class="reference external" href="https://arxiv.org/abs/2107.06427">https://arxiv.org/abs/2107.06427</a></p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "sparsh-ai/coldstart-recsys",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="T951866_DropoutNet_Cold_start_Recommendation_on_CiteULike_dataset.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">DropoutNet Cold-start Recommendation on CiteULike dataset</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="T722684_TaNP_Cold_start_Recommender_on_LastFM_dataset.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">TaNP Cold-start Recommender on LastFM dataset</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Sparsh A.<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>