
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TaNP Cold-start Recommender on LastFM dataset &#8212; coldstart-recsys</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="AGGN Cold-start Recommendation on ML-100k" href="T290734_AGGN_Cold_start_Recommendation_on_ML_100k.html" />
    <link rel="prev" title="MetaTL for Cold-start users on Amazon Electronics dataset" href="T714933_MetaTL_for_Cold_start_users_on_Amazon_Electronics_dataset.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">coldstart-recsys</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="L281872_Cold_Start_Recommendations.html">
   Cold-Start Recommendations
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Tutorials
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="T847725_Attribute_to_Feature_Mappings_for_Cold_Start_Recommendations.html">
   Attribute to Feature Mappings for Cold-Start Recommendations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T457846_LightFM_Cold_start_on_ML_10m.html">
   LightFM Cold-start on ML-10m
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T459379_EMCDR_on_MovieLens_Netflix_dataset.html">
   EMCDR on MovieLens-Netflix dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T229879_HERS_Cold_start_Recommendations_on_LastFM_dataset.html">
   HERS Cold-start Recommendations on LastFM dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T316836_Collective_Matrix_Factorization_on_ML_1m.html">
   Collective Matrix Factorization on ML-1m
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T490340_Double_domain_recommendations_on_ML_1m.html">
   Double domain recommendations on ML-1m
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T951866_DropoutNet_Cold_start_Recommendation_on_CiteULike_dataset.html">
   DropoutNet Cold-start Recommendation on CiteULike dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T714933_MetaTL_for_Cold_start_users_on_Amazon_Electronics_dataset.html">
   MetaTL for Cold-start users on Amazon Electronics dataset
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   TaNP Cold-start Recommender on LastFM dataset
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T290734_AGGN_Cold_start_Recommendation_on_ML_100k.html">
   AGGN Cold-start Recommendation on ML-100k
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T519611_DaRE_Cross_domain_recommender_on_Amazon_Reviews_dataset.html">
   DaRE Cross-domain recommender on Amazon Reviews dataset
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/T722684_TaNP_Cold_start_Recommender_on_LastFM_dataset.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/sparsh-ai/coldstart-recsys/main?urlpath=tree/docs/T722684_TaNP_Cold_start_Recommender_on_LastFM_dataset.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/sparsh-ai/coldstart-recsys/blob/main/docs/T722684_TaNP_Cold_start_Recommender_on_LastFM_dataset.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#background">
   Background
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#meta-learning-in-recommenders">
     Meta Learning in Recommenders
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports">
     Imports
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data">
     Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#params">
     Params
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#utils">
   Utils
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dataset">
   Dataset
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-definition">
   Model Definition
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#embeddings">
     Embeddings
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tanp">
     TaNP
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluation-modules">
   Evaluation modules
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#metrics">
     Metrics
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#testing">
     Testing
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#training-and-evaluation">
   Training and Evaluation
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="tanp-cold-start-recommender-on-lastfm-dataset">
<h1>TaNP Cold-start Recommender on LastFM dataset<a class="headerlink" href="#tanp-cold-start-recommender-on-lastfm-dataset" title="Permalink to this headline">¶</a></h1>
<p>Recent studies seek to address this challenge from the perspective of meta learning, and most of them follow a manner of parameter initialization, where the model parameters can be learned by a few steps of gradient updates. While these gradient-based meta-learning models achieve promising performances to some extent, a fundamental problem of them is how to adapt the global knowledge learned from previous tasks for the recommendations of cold-start users more effectively.</p>
<p>TaNP directly maps the observed interactions of each user to a predictive distribution, sidestepping some training issues in gradient-based meta-learning models. More importantly, to balance the trade-off between model capacity and adaptation reliability, TaNP uses a novel task-adaptive mechanism. It enables this model to learn the relevance of different tasks and customize the global knowledge to the task-related decoder parameters for estimating user preferences.</p>
<p>Inspired by the significant improvements of meta learning, the pioneering work of <a class="reference external" href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/46346.pdf">Vartak et. al.</a> provides a meta-learning strategy to solve cold-start problems. It uses a task-dependent way to generate the varying biases of decision layers for different tasks, but it is prone to underfitting and is not flexible enough to handle various recommendation scenarios. <a class="reference external" href="https://arxiv.org/abs/1908.00413">MeLU</a> adopts the framework of MAML. Specifically, it divides the model parameters into two groups, i.e., the personalized parameter and the embedding parameter. The personalized parameter is characterized as a fully-connected DNN to estimate user preferences. The embedding parameter is referred as the embeddings of users and items learned from side-information. An inner-outer loop is used to update these two groups of parameters. In the inner loop, the personalized parameter is locally updated via the prediction loss of support set in current task. In the outer loop, these parameters are globally updated according to the prediction loss of query sets in multiple tasks. Through the fashion of local-global update, MeLU can provide a shared initialization for different tasks. The later work <a class="reference external" href="https://www.semanticscholar.org/paper/Meta-Learning-for-User-Cold-Start-Recommendation-Bharadhwaj/f3135b553f592dc42d4202c90739c99486103fc3">MetaCS</a> is much similar to MeLU, and the main difference is that the local-global update involves all parameters from input embedding to model prediction. To generalize well for different tasks, <a class="reference external" href="https://www.kdd.org/kdd2020/accepted-papers/view/meta-learning-on-heterogeneous-information-networks-for-cold-start-recommen">MetaHIN</a> and <a class="reference external" href="https://arxiv.org/abs/2007.03183">MAMO</a> propose different task-specific adaptation strategies. In particular, MetaHIN incorporates heterogeneous information networks (HINs) into MAML to capture rich semantics of meta-paths. MAMO introduces two memory matrices based on user profiles: a feature-specific memory that provides a specific bias term for the shared parameter initialization; a task-specific memory that guides the model for predictions. However, these two gradient-based meta-learning models may still suffer from potential training issues in MAML, and the model-level innovations of them are closely related with side-information, which limits their application scenarios.</p>
<div class="section" id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<div class="section" id="meta-learning-in-recommenders">
<h3>Meta Learning in Recommenders<a class="headerlink" href="#meta-learning-in-recommenders" title="Permalink to this headline">¶</a></h3>
<p>Inspired by the huge progress on few-shot learning and meta learning, there emerge some promising works on solving cold-start problems from the perspective of meta learning, where making recommendations for one user is regarded as a single task.</p>
<p>In the training phase, they try to derive the global knowledge across different tasks as a strong generalization prior. When a cold-start user comes in the test phase, the personalized recommendation for her/him can be predicted with only a few interacted items are available, but does so by using the global knowledge already learned.</p>
<p>Most meta-learning recommenders are built upon the well-known framework of model-agnostic meta learning (MAML), aiming to learn a parameter initialization where a few steps of gradient updates will lead to good performances on the new tasks. A typical assumption here is the recommendations of different users are highly relevant. However, this assumption does not necessarily hold in actual scenarios. When the users exhibit different purchase intentions, the task relevance among them is actually very weak, which makes it problematic to find a shared parameter initialization optimal for all users. As shown in the image below:</p>
<p><center><img src='_images/T722684_1.png'></center></p></div>
</div>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<div class="section" id="imports">
<h3>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">optim</span>
<span class="kn">import</span> <span class="nn">torch.nn.init</span> <span class="k">as</span> <span class="nn">init</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">torch.autograd</span> <span class="kn">import</span> <span class="n">Variable</span>
<span class="kn">from</span> <span class="nn">torch.optim.optimizer</span> <span class="kn">import</span> <span class="n">Optimizer</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="data">
<h3>Data<a class="headerlink" href="#data" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!wget -q --show-progress https://github.com/sparsh-ai/coldstart-recsys/raw/main/data/TaNP/data.zip
!unzip data.zip
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="params">
<h3>Params<a class="headerlink" href="#params" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--data_dir&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;data/lastfm_20&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--model_save_dir&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;save_model_dir&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--id&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;used for save hyper-parameters.&#39;</span><span class="p">)</span>

<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--first_embedding_dim&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Embedding dimension for item and user.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--second_embedding_dim&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Embedding dimension for item and user.&#39;</span><span class="p">)</span>

<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--z1_dim&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The dimension of z1 in latent path.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--z2_dim&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The dimension of z2 in latent path.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--z_dim&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The dimension of z in latent path.&#39;</span><span class="p">)</span>

<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--enc_h1_dim&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The hidden first dimension of encoder.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--enc_h2_dim&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The hidden second dimension of encoder.&#39;</span><span class="p">)</span>

<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--taskenc_h1_dim&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The hidden first dimension of task encoder.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--taskenc_h2_dim&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The hidden second dimension of task encoder.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--taskenc_final_dim&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The hidden second dimension of task encoder.&#39;</span><span class="p">)</span>

<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--clusters_k&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Cluster numbers of tasks.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--temperature&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;used for student-t distribution.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--lambda&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;used to balance the clustering loss and NP loss.&#39;</span><span class="p">)</span>

<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dec_h1_dim&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The hidden first dimension of encoder.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dec_h2_dim&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The hidden second dimension of encoder.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dec_h3_dim&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The hidden third dimension of encoder.&#39;</span><span class="p">)</span>

<span class="c1"># # used for movie datasets</span>
<span class="c1"># parser.add_argument(&#39;--num_gender&#39;, type=int, default=2, help=&#39;User information.&#39;)</span>
<span class="c1"># parser.add_argument(&#39;--num_age&#39;, type=int, default=7, help=&#39;User information.&#39;)</span>
<span class="c1"># parser.add_argument(&#39;--num_occupation&#39;, type=int, default=21, help=&#39;User information.&#39;)</span>
<span class="c1"># parser.add_argument(&#39;--num_zipcode&#39;, type=int, default=3402, help=&#39;User information.&#39;)</span>
<span class="c1"># parser.add_argument(&#39;--num_rate&#39;, type=int, default=6, help=&#39;Item information.&#39;)</span>
<span class="c1"># parser.add_argument(&#39;--num_genre&#39;, type=int, default=25, help=&#39;Item information.&#39;)</span>
<span class="c1"># parser.add_argument(&#39;--num_director&#39;, type=int, default=2186, help=&#39;Item information.&#39;)</span>
<span class="c1"># parser.add_argument(&#39;--num_actor&#39;, type=int, default=8030, help=&#39;Item information.&#39;)</span>

<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dropout_rate&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;used in encoder and decoder.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--lr&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Applies to SGD and Adagrad.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--optim&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;sgd, adagrad, adam or adamax.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--num_epoch&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--batch_size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--train_ratio&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Warm user ratio for training.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--valid_ratio&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Cold user ratio for validation.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--seed&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2020</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--save&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--use_cuda&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cpu&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Ignore CUDA.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--support_size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--query_size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--max_len&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The max length of interactions for each user.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--context_min&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Minimum size of context range.&#39;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">{})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">seed_everything</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">1023</span><span class="p">):</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PYTHONHASHSEED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">seed</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">seed</span>
<span class="n">seed_everything</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cpu</span><span class="p">:</span>
    <span class="n">args</span><span class="o">.</span><span class="n">use_cuda</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">use_cuda</span><span class="p">:</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

<span class="n">opt</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="utils">
<h2>Utils<a class="headerlink" href="#utils" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#convert userids to userdict key-id(int), val:onehot_vector(tensor)</span>
<span class="c1">#element in list is str type.</span>
<span class="k">def</span> <span class="nf">to_onehot_dict</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="nb">dict</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
        <span class="n">element</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="n">vector</span><span class="p">[:,</span> <span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="nb">dict</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="n">vector</span>
    <span class="k">return</span> <span class="nb">dict</span>

<span class="k">def</span> <span class="nf">load_list</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="n">list_</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">list_</span>

<span class="c1"># used for merge dictionaries.</span>
<span class="k">def</span> <span class="nf">merge_key</span><span class="p">(</span><span class="n">dict1</span><span class="p">,</span> <span class="n">dict2</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">dict1</span><span class="p">,</span> <span class="o">**</span><span class="n">dict2</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="k">def</span> <span class="nf">merge_value</span><span class="p">(</span><span class="n">dict1</span><span class="p">,</span> <span class="n">dict2</span><span class="p">):</span> <span class="c1"># merge and item_cold</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dict2</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dict1</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># if list(set(dict1[key]+value)) the final number of movies-1m is 1000205</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="n">dict1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">+</span><span class="n">value</span>
            <span class="n">dict1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unexpected key.&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">count_values</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="n">count_val</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">count_val</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">count_val</span>

<span class="k">def</span> <span class="nf">construct_dictionary</span><span class="p">(</span><span class="n">user_list</span><span class="p">,</span> <span class="n">total_dict</span><span class="p">):</span>
    <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">user_list</span><span class="p">)):</span>
        <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">user_list</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="n">total_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">user_list</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
    <span class="k">return</span> <span class="nb">dict</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">### IO</span>
<span class="k">def</span> <span class="nf">check_dir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Directory </span><span class="si">{}</span><span class="s2"> does not exist. Exit.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_files</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">{}</span><span class="s2"> does not exist. Exit.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">ensure_dir</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Directory </span><span class="si">{}</span><span class="s2"> do not exist; creating...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">save_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Config saved to file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">config</span>


<span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Config loaded from file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">config</span>


<span class="k">def</span> <span class="nf">print_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">info</span> <span class="o">=</span> <span class="s2">&quot;Running with the following configs:</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">info</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="s2"> : </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">info</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span>


<span class="k">class</span> <span class="nc">FileLogger</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A file logger that opens the file periodically and write to it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="c1"># remove the old file</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyAdagrad</span><span class="p">(</span><span class="n">Optimizer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;My modification of the Adagrad optimizer that allows to specify an initial</span>
<span class="sd">    accumulater value. This mimics the behavior of the default Adagrad implementation</span>
<span class="sd">    in Tensorflow. The default PyTorch Adagrad uses 0 for initial acculmulator value.</span>
<span class="sd">    Arguments:</span>
<span class="sd">        params (iterable): iterable of parameters to optimize or dicts defining</span>
<span class="sd">            parameter groups</span>
<span class="sd">        lr (float, optional): learning rate (default: 1e-2)</span>
<span class="sd">        lr_decay (float, optional): learning rate decay (default: 0)</span>
<span class="sd">        init_accu_value (float, optional): initial accumulater value.</span>
<span class="sd">        weight_decay (float, optional): weight decay (L2 penalty) (default: 0)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">lr_decay</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">init_accu_value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">lr_decay</span><span class="o">=</span><span class="n">lr_decay</span><span class="p">,</span> <span class="n">init_accu_value</span><span class="o">=</span><span class="n">init_accu_value</span><span class="p">,</span> \
                <span class="n">weight_decay</span><span class="o">=</span><span class="n">weight_decay</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyAdagrad</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">defaults</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]:</span>
                <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">())</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span>\
                        <span class="n">init_accu_value</span>

    <span class="k">def</span> <span class="nf">share_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]:</span>
                <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">share_memory_</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">closure</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs a single optimization step.</span>
<span class="sd">        Arguments:</span>
<span class="sd">            closure (callable, optional): A closure that reevaluates the model</span>
<span class="sd">                and returns the loss.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">closure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">closure</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_groups</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">grad</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span>
                <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">is_sparse</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;weight_decay option is not compatible with sparse gradients &quot;</span><span class="p">)</span>
                    <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

                <span class="n">clr</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;lr_decay&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">is_sparse</span><span class="p">:</span>
                    <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">.</span><span class="n">coalesce</span><span class="p">()</span>  <span class="c1"># the update is non-linear so indices must be unique</span>
                    <span class="n">grad_indices</span> <span class="o">=</span> <span class="n">grad</span><span class="o">.</span><span class="n">_indices</span><span class="p">()</span>
                    <span class="n">grad_values</span> <span class="o">=</span> <span class="n">grad</span><span class="o">.</span><span class="n">_values</span><span class="p">()</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grad</span><span class="o">.</span><span class="n">size</span><span class="p">()])</span>

                    <span class="k">def</span> <span class="nf">make_sparse</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
                        <span class="n">constructor</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">grad_indices</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">values</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">constructor</span><span class="p">()</span>
                        <span class="k">return</span> <span class="n">constructor</span><span class="p">(</span><span class="n">grad_indices</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                    <span class="n">state</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="n">make_sparse</span><span class="p">(</span><span class="n">grad_values</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
                    <span class="n">std</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_sparse_mask</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
                    <span class="n">std_values</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">_values</span><span class="p">()</span><span class="o">.</span><span class="n">sqrt_</span><span class="p">()</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="mf">1e-10</span><span class="p">)</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="o">-</span><span class="n">clr</span><span class="p">,</span> <span class="n">make_sparse</span><span class="p">(</span><span class="n">grad_values</span> <span class="o">/</span> <span class="n">std_values</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">state</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">addcmul_</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">grad</span><span class="p">)</span>
                    <span class="n">std</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="mf">1e-10</span><span class="p">)</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">addcdiv_</span><span class="p">(</span><span class="o">-</span><span class="n">clr</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">loss</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">### torch specific functions</span>
<span class="k">def</span> <span class="nf">get_optimizer</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;sgd&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">l2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;adagrad&#39;</span><span class="p">,</span> <span class="s1">&#39;myadagrad&#39;</span><span class="p">]:</span>
        <span class="c1"># use my own adagrad to allow for init accumulator value</span>
        <span class="k">return</span> <span class="n">MyAdagrad</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">init_accu_value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">l2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;adam&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">l2</span><span class="p">)</span> <span class="c1"># use default lr</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;adamax&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adamax</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">l2</span><span class="p">)</span> <span class="c1"># use default lr</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;adadelta&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adadelta</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">l2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unsupported optimizer: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">change_lr</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">new_lr</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">param_group</span> <span class="ow">in</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">:</span>
        <span class="n">param_group</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_lr</span>


<span class="k">def</span> <span class="nf">flatten_indices</span><span class="p">(</span><span class="n">seq_lens</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
    <span class="n">flat</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seq_lens</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
            <span class="n">flat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flat</span>


<span class="k">def</span> <span class="nf">set_cuda</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">cuda</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cuda</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">var</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">var</span>


<span class="k">def</span> <span class="nf">keep_partial_grad</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="n">topk</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Keep only the topk rows of grads.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">topk</span> <span class="o">&lt;</span> <span class="n">grad</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">grad</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">topk</span><span class="p">:]</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">grad</span>

<span class="c1">### model IO</span>
<span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
        <span class="s1">&#39;optimizer&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
        <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">opt</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ Warning: model saving failed. ]&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dump</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ Fail: model loading failed. ]&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">dump</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">optimizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">dump</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">])</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">dump</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">opt</span>


<span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dump</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ Fail: model loading failed. ]&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dump</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="dataset">
<h2>Dataset<a class="headerlink" href="#dataset" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Preprocess</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Preprocess the training, validation and test data.</span>
<span class="sd">    Generate the episode-style data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">opt</span>
        <span class="c1"># warm data ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_ratio</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;train_ratio&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_ratio</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;valid_ratio&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_ratio</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_ratio</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_path</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">support_size</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;support_size&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_size</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;query_size&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;max_len&#39;</span><span class="p">]</span>
        <span class="c1"># save one-hot dimension length</span>
        <span class="n">uf_dim</span><span class="p">,</span> <span class="n">if_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uf_dim</span> <span class="o">=</span> <span class="n">uf_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">if_dim</span> <span class="o">=</span> <span class="n">if_dim</span>

    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Preprocess the data and convert to ids. &quot;&quot;&quot;</span>
        <span class="c1">#Create training-validation-test datasets</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Create training, validation and test data from scratch!&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./</span><span class="si">{}</span><span class="s1">/interaction_dict_x.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">inter_dict_x</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./</span><span class="si">{}</span><span class="s1">/interaction_dict_y.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">inter_dict_y</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The size of total interactions is </span><span class="si">%d</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count_values</span><span class="p">(</span><span class="n">inter_dict_x</span><span class="p">)))</span>  <span class="c1"># 42346</span>
        <span class="k">assert</span> <span class="n">count_values</span><span class="p">(</span><span class="n">inter_dict_x</span><span class="p">)</span> <span class="o">==</span> <span class="n">count_values</span><span class="p">(</span><span class="n">inter_dict_y</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./</span><span class="si">{}</span><span class="s1">/user_list.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">userids</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./</span><span class="si">{}</span><span class="s1">/item_list.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">itemids</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

        <span class="c1">#userids = list(inter_dict_x.keys())</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">userids</span><span class="p">)</span>
        <span class="n">warm_user_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">userids</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_ratio</span><span class="p">)</span>
        <span class="n">valid_user_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">userids</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_ratio</span><span class="p">)</span>
        <span class="n">warm_users</span> <span class="o">=</span> <span class="n">userids</span><span class="p">[:</span><span class="n">warm_user_size</span><span class="p">]</span>
        <span class="n">valid_users</span> <span class="o">=</span> <span class="n">userids</span><span class="p">[</span><span class="n">warm_user_size</span><span class="p">:</span><span class="n">warm_user_size</span><span class="o">+</span><span class="n">valid_user_size</span><span class="p">]</span>
        <span class="n">cold_users</span> <span class="o">=</span> <span class="n">userids</span><span class="p">[</span><span class="n">warm_user_size</span><span class="o">+</span><span class="n">valid_user_size</span><span class="p">:]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">userids</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">warm_users</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_users</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">cold_users</span><span class="p">)</span>


            <span class="c1"># Construct the training data dict</span>
        <span class="n">training_dict_x</span> <span class="o">=</span> <span class="n">construct_dictionary</span><span class="p">(</span><span class="n">warm_users</span><span class="p">,</span> <span class="n">inter_dict_x</span><span class="p">)</span>
        <span class="n">training_dict_y</span> <span class="o">=</span> <span class="n">construct_dictionary</span><span class="p">(</span><span class="n">warm_users</span><span class="p">,</span> <span class="n">inter_dict_y</span><span class="p">)</span>

            <span class="c1">#Avoid the new items shown in test data in the case of cold user.</span>
        <span class="n">item_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">training_dict_x</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">item_set</span> <span class="o">=</span> <span class="n">item_set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># Construct one-hot dictionary</span>
        <span class="n">user_dict</span> <span class="o">=</span> <span class="n">to_onehot_dict</span><span class="p">(</span><span class="n">userids</span><span class="p">)</span>
        <span class="c1"># only items contained in all data are encoded.</span>
        <span class="n">item_dict</span> <span class="o">=</span> <span class="n">to_onehot_dict</span><span class="p">(</span><span class="n">itemids</span><span class="p">)</span>

        <span class="c1"># This part of data is not used, so we do not process it temporally.</span>
        <span class="n">valid_dict_x</span> <span class="o">=</span> <span class="n">construct_dictionary</span><span class="p">(</span><span class="n">valid_users</span><span class="p">,</span> <span class="n">inter_dict_x</span><span class="p">)</span>
        <span class="n">valid_dict_y</span> <span class="o">=</span> <span class="n">construct_dictionary</span><span class="p">(</span><span class="n">valid_users</span><span class="p">,</span> <span class="n">inter_dict_y</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">count_values</span><span class="p">(</span><span class="n">valid_dict_x</span><span class="p">)</span> <span class="o">==</span> <span class="n">count_values</span><span class="p">(</span><span class="n">valid_dict_y</span><span class="p">)</span>

        <span class="n">test_dict_x</span> <span class="o">=</span> <span class="n">construct_dictionary</span><span class="p">(</span><span class="n">cold_users</span><span class="p">,</span> <span class="n">inter_dict_x</span><span class="p">)</span>
        <span class="n">test_dict_y</span> <span class="o">=</span> <span class="n">construct_dictionary</span><span class="p">(</span><span class="n">cold_users</span><span class="p">,</span> <span class="n">inter_dict_y</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">count_values</span><span class="p">(</span><span class="n">test_dict_x</span><span class="p">)</span> <span class="o">==</span> <span class="n">count_values</span><span class="p">(</span><span class="n">test_dict_y</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Before delete new items in test data, test data has </span><span class="si">%d</span><span class="s1"> interactions.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count_values</span><span class="p">(</span><span class="n">test_dict_x</span><span class="p">)))</span>

        <span class="c1">#Delete the new items in test data.</span>
        <span class="n">unseen_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">test_dict_x</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_dict_y</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">unseen_item_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item_set</span><span class="p">]</span>
            <span class="n">unseen_count</span><span class="o">+=</span><span class="nb">len</span><span class="p">(</span><span class="n">unseen_item_index</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unseen_item_index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_value_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unseen_item_index</span><span class="p">]</span>
                <span class="n">new_value_y</span> <span class="o">=</span> <span class="p">[</span><span class="n">test_dict_y</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unseen_item_index</span><span class="p">]</span>
                <span class="n">test_dict_x</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value_x</span>
                <span class="n">test_dict_y</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value_y</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;After delete new items in test data, test data has </span><span class="si">%d</span><span class="s1"> interactions.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count_values</span><span class="p">(</span><span class="n">test_dict_x</span><span class="p">)))</span>
        <span class="k">assert</span> <span class="n">count_values</span><span class="p">(</span><span class="n">test_dict_x</span><span class="p">)</span> <span class="o">==</span> <span class="n">count_values</span><span class="p">(</span><span class="n">test_dict_y</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The number of total unseen interactions is </span><span class="si">%d</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">unseen_count</span><span class="p">))</span>

        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">training_dict_x</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/training_dict_x_</span><span class="si">{:2f}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_ratio</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">training_dict_y</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/training_dict_y_</span><span class="si">{:2f}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_ratio</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">valid_dict_x</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/valid_dict_x_</span><span class="si">{:2f}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_ratio</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">valid_dict_y</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/valid_dict_y_</span><span class="si">{:2f}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_ratio</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">test_dict_x</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/test_dict_x_</span><span class="si">{:2f}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_ratio</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">test_dict_y</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/test_dict_y_</span><span class="si">{:2f}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_ratio</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">generate_episodes</span><span class="p">(</span><span class="n">dict_x</span><span class="p">,</span> <span class="n">dict_y</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">support_size</span><span class="p">,</span> <span class="n">query_size</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="nb">dir</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="nb">dir</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="s2">&quot;evidence&quot;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dict_x</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">u_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                    <span class="n">seen_music_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_x</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">u_id</span><span class="p">)])</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">seen_music_len</span><span class="p">))</span>
                    <span class="c1"># filter some users with their interactions, i.e., tasks</span>
                    <span class="k">if</span> <span class="n">seen_music_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">support_size</span> <span class="o">+</span> <span class="n">query_size</span><span class="p">)</span> <span class="ow">or</span> <span class="n">seen_music_len</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
                    <span class="n">tmp_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_x</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">u_id</span><span class="p">)])</span>
                    <span class="n">tmp_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_y</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">u_id</span><span class="p">)])</span>

                    <span class="n">support_x_app</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">m_id</span> <span class="ow">in</span> <span class="n">tmp_x</span><span class="p">[</span><span class="n">indices</span><span class="p">[:</span><span class="n">support_size</span><span class="p">]]:</span>
                        <span class="n">m_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m_id</span><span class="p">)</span>
                        <span class="n">tmp_x_converted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">item_dict</span><span class="p">[</span><span class="n">m_id</span><span class="p">],</span> <span class="n">user_dict</span><span class="p">[</span><span class="n">u_id</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">support_x_app</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">support_x_app</span><span class="p">,</span> <span class="n">tmp_x_converted</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">support_x_app</span> <span class="o">=</span> <span class="n">tmp_x_converted</span>

                    <span class="n">query_x_app</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">m_id</span> <span class="ow">in</span> <span class="n">tmp_x</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">support_size</span><span class="p">:]]:</span>
                        <span class="n">m_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m_id</span><span class="p">)</span>
                        <span class="n">u_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                        <span class="n">tmp_x_converted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">item_dict</span><span class="p">[</span><span class="n">m_id</span><span class="p">],</span> <span class="n">user_dict</span><span class="p">[</span><span class="n">u_id</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">query_x_app</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">query_x_app</span><span class="p">,</span> <span class="n">tmp_x_converted</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">query_x_app</span> <span class="o">=</span> <span class="n">tmp_x_converted</span>

                    <span class="n">support_y_app</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">tmp_y</span><span class="p">[</span><span class="n">indices</span><span class="p">[:</span><span class="n">support_size</span><span class="p">]])</span>
                    <span class="n">query_y_app</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">tmp_y</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">support_size</span><span class="p">:]])</span>

                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">support_x_app</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/supp_x_</span><span class="si">{}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">support_y_app</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/supp_y_</span><span class="si">{}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">query_x_app</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/query_x_</span><span class="si">{}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">query_y_app</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/query_y_</span><span class="si">{}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>
                    <span class="c1"># used for evidence candidate selection</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/supp_x_</span><span class="si">{}</span><span class="s2">_u_m_ids.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="s2">&quot;evidence&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">m_id</span> <span class="ow">in</span> <span class="n">tmp_x</span><span class="p">[</span><span class="n">indices</span><span class="p">[:</span><span class="n">support_size</span><span class="p">]]:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">u_id</span><span class="p">,</span> <span class="n">m_id</span><span class="p">))</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/query_x_</span><span class="si">{}</span><span class="s2">_u_m_ids.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset_path</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="s2">&quot;evidence&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">m_id</span> <span class="ow">in</span> <span class="n">tmp_x</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">support_size</span><span class="p">:]]:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">u_id</span><span class="p">,</span> <span class="n">m_id</span><span class="p">))</span>
                    <span class="n">idx</span><span class="o">+=</span><span class="mi">1</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generate eposide data for training.&quot;</span><span class="p">)</span>
        <span class="n">generate_episodes</span><span class="p">(</span><span class="n">training_dict_x</span><span class="p">,</span> <span class="n">training_dict_y</span><span class="p">,</span> <span class="s2">&quot;training&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">support_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generate eposide data for validation.&quot;</span><span class="p">)</span>
        <span class="n">generate_episodes</span><span class="p">(</span><span class="n">valid_dict_x</span><span class="p">,</span> <span class="n">valid_dict_y</span><span class="p">,</span> <span class="s2">&quot;validation&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">support_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generate eposide data for testing.&quot;</span><span class="p">)</span>
        <span class="n">generate_episodes</span><span class="p">(</span><span class="n">test_dict_x</span><span class="p">,</span> <span class="n">test_dict_y</span><span class="p">,</span> <span class="s2">&quot;testing&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">support_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">userids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">itemids</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="model-definition">
<h2>Model Definition<a class="headerlink" href="#model-definition" title="Permalink to this headline">¶</a></h2>
<p>TaNP includes the encoder <span class="math notranslate nohighlight">\(ℎ_\theta\)</span>, the customization module (task identity network <span class="math notranslate nohighlight">\(𝑚_\phi\)</span> and global pool 𝑨) and the adaptive decoder <span class="math notranslate nohighlight">\(𝑔_{\omega𝑖}\)</span>. Both of <span class="math notranslate nohighlight">\(𝑆_𝑖\)</span> and <span class="math notranslate nohighlight">\(\tau_𝑖\)</span> are encoded by <span class="math notranslate nohighlight">\(ℎ_\theta\)</span> to generate the variational prior and posterior, respectively. The final task embedding <span class="math notranslate nohighlight">\(𝒐_𝑖\)</span> learned from the customized module is used to modulate the model parameters of <span class="math notranslate nohighlight">\(𝑔_{\omega𝑖} \cdot 𝒛_𝑖\)</span> sampled from <span class="math notranslate nohighlight">\(𝑞(𝒛_𝑖|\tau_𝑖)\)</span> is concatenated with <span class="math notranslate nohighlight">\(𝒙_{𝑖,𝑗}\)</span> to predict <span class="math notranslate nohighlight">\(\hat{𝑦}_{𝑖,𝑗}\)</span> via <span class="math notranslate nohighlight">\(𝑔_{\omega𝑖}\)</span>.</p>
<div class="section" id="embeddings">
<h3>Embeddings<a class="headerlink" href="#embeddings" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Item</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;if_dim&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_embedding_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;first_embedding_dim&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">second_embedding_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;second_embedding_dim&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">first_embedding_layer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
            <span class="n">in_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_dim</span><span class="p">,</span>
            <span class="n">out_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">first_embedding_dim</span><span class="p">,</span>
            <span class="n">bias</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">second_embedding_layer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
            <span class="n">in_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">first_embedding_dim</span><span class="p">,</span>
            <span class="n">out_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">second_embedding_dim</span><span class="p">,</span>
            <span class="n">bias</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">first_hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_embedding_layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">first_hidden</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">first_hidden</span><span class="p">)</span>
        <span class="n">sec_hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">second_embedding_layer</span><span class="p">(</span><span class="n">first_hidden</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">sec_hidden</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Movie_item</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Moive_item</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_rate</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_rate&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_genre</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_genre&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_director</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_director&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_actor</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_actor&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;embedding_dim&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_rate</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
            <span class="n">num_embeddings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_rate</span><span class="p">,</span> 
            <span class="n">embedding_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_genre</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
            <span class="n">in_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_genre</span><span class="p">,</span>
            <span class="n">out_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">,</span>
            <span class="n">bias</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_director</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
            <span class="n">in_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_director</span><span class="p">,</span>
            <span class="n">out_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">,</span>
            <span class="n">bias</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_actor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
            <span class="n">in_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_actor</span><span class="p">,</span>
            <span class="n">out_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">,</span>
            <span class="n">bias</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rate_idx</span><span class="p">,</span> <span class="n">genre_idx</span><span class="p">,</span> <span class="n">director_idx</span><span class="p">,</span> <span class="n">actors_idx</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">rate_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_rate</span><span class="p">(</span><span class="n">rate_idx</span><span class="p">)</span>
        <span class="n">genre_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_genre</span><span class="p">(</span><span class="n">genre_idx</span><span class="o">.</span><span class="n">float</span><span class="p">())</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">genre_idx</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">director_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_director</span><span class="p">(</span><span class="n">director_idx</span><span class="o">.</span><span class="n">float</span><span class="p">())</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">director_idx</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">actors_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_actor</span><span class="p">(</span><span class="n">actors_idx</span><span class="o">.</span><span class="n">float</span><span class="p">())</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">actors_idx</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">rate_emb</span><span class="p">,</span> <span class="n">genre_emb</span><span class="p">,</span> <span class="n">director_emb</span><span class="p">,</span> <span class="n">actors_emb</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;uf_dim&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_embedding_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;first_embedding_dim&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">second_embedding_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;second_embedding_dim&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">first_embedding_layer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
            <span class="n">in_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_dim</span><span class="p">,</span>
            <span class="n">out_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">first_embedding_dim</span><span class="p">,</span>
            <span class="n">bias</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">second_embedding_layer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
            <span class="n">in_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">first_embedding_dim</span><span class="p">,</span>
            <span class="n">out_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">second_embedding_dim</span><span class="p">,</span>
            <span class="n">bias</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">first_hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_embedding_layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">first_hidden</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">first_hidden</span><span class="p">)</span>
        <span class="n">sec_hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">second_embedding_layer</span><span class="p">(</span><span class="n">first_hidden</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">sec_hidden</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Movie_user</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Movie_user</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_gender</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_gender&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_age</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_age&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_occupation</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_occupation&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_zipcode</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_zipcode&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;embedding_dim&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_gender</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
            <span class="n">num_embeddings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_gender</span><span class="p">,</span>
            <span class="n">embedding_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_age</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
            <span class="n">num_embeddings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_age</span><span class="p">,</span>
            <span class="n">embedding_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_occupation</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
            <span class="n">num_embeddings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_occupation</span><span class="p">,</span>
            <span class="n">embedding_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_area</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
            <span class="n">num_embeddings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_zipcode</span><span class="p">,</span>
            <span class="n">embedding_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_dim</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gender_idx</span><span class="p">,</span> <span class="n">age_idx</span><span class="p">,</span> <span class="n">occupation_idx</span><span class="p">,</span> <span class="n">area_idx</span><span class="p">):</span>
        <span class="n">gender_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_gender</span><span class="p">(</span><span class="n">gender_idx</span><span class="p">)</span>
        <span class="n">age_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_age</span><span class="p">(</span><span class="n">age_idx</span><span class="p">)</span>
        <span class="n">occupation_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_occupation</span><span class="p">(</span><span class="n">occupation_idx</span><span class="p">)</span>
        <span class="n">area_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_area</span><span class="p">(</span><span class="n">area_idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">gender_emb</span><span class="p">,</span> <span class="n">age_emb</span><span class="p">,</span> <span class="n">occupation_emb</span><span class="p">,</span> <span class="n">area_emb</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Encoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="c1">#Maps an (x_i, y_i) pair to a representation r_i.</span>
    <span class="c1"># Add the dropout into encoder ---03.31</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_dim</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">h1_dim</span><span class="p">,</span> <span class="n">h2_dim</span><span class="p">,</span> <span class="n">z1_dim</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Encoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x_dim</span> <span class="o">=</span> <span class="n">x_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_dim</span> <span class="o">=</span> <span class="n">y_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h1_dim</span> <span class="o">=</span> <span class="n">h1_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h2_dim</span> <span class="o">=</span> <span class="n">h2_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z1_dim</span> <span class="o">=</span> <span class="n">z1_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span> <span class="o">=</span> <span class="n">dropout_rate</span>

        <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_dim</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h1_dim</span><span class="p">),</span>
                  <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span><span class="p">),</span>
                  <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                  <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h1_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2_dim</span><span class="p">),</span>
                  <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span><span class="p">),</span>
                  <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                  <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h2_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z1_dim</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input_to_hidden</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">input_pairs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_to_hidden</span><span class="p">(</span><span class="n">input_pairs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MuSigmaEncoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z1_dim</span><span class="p">,</span> <span class="n">z2_dim</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MuSigmaEncoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">z1_dim</span> <span class="o">=</span> <span class="n">z1_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z2_dim</span> <span class="o">=</span> <span class="n">z2_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_dim</span> <span class="o">=</span> <span class="n">z_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_to_hidden</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z1_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z2_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_to_mu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z2_dim</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_to_logsigma</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z2_dim</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z_input</span><span class="p">):</span>
        <span class="n">hidden</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z_to_hidden</span><span class="p">(</span><span class="n">z_input</span><span class="p">))</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_to_mu</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
        <span class="n">log_sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_to_logsigma</span><span class="p">(</span><span class="n">hidden</span><span class="p">)</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">log_sigma</span><span class="p">)</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">eps</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mu</span><span class="p">,</span> <span class="n">log_sigma</span><span class="p">,</span> <span class="n">z</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TaskEncoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_dim</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">h1_dim</span><span class="p">,</span> <span class="n">h2_dim</span><span class="p">,</span> <span class="n">final_dim</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TaskEncoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_dim</span> <span class="o">=</span> <span class="n">x_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_dim</span> <span class="o">=</span> <span class="n">y_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h1_dim</span> <span class="o">=</span> <span class="n">h1_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h2_dim</span> <span class="o">=</span> <span class="n">h2_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_dim</span> <span class="o">=</span> <span class="n">final_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span> <span class="o">=</span> <span class="n">dropout_rate</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_dim</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h1_dim</span><span class="p">),</span>
                  <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span><span class="p">),</span>
                  <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                  <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h1_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2_dim</span><span class="p">),</span>
                  <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span><span class="p">),</span>
                  <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                  <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h2_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_dim</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input_to_hidden</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">input_pairs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_to_hidden</span><span class="p">(</span><span class="n">input_pairs</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MemoryUnit</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="c1"># clusters_k is k keys</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clusters_k</span><span class="p">,</span> <span class="n">emb_size</span><span class="p">,</span> <span class="n">temperature</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MemoryUnit</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clusters_k</span> <span class="o">=</span> <span class="n">clusters_k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span> <span class="o">=</span> <span class="n">emb_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">init</span><span class="o">.</span><span class="n">xavier_uniform_</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters_k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_size</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_embed</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">task_embed</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">((</span><span class="n">res</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># 1*k</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">res</span> <span class="o">/</span> <span class="n">res</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># 1*k, k*d, 1*d</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
        <span class="c1"># simple add operation</span>
        <span class="n">new_task_embed</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="n">task_embed</span>
        <span class="c1"># calculate target distribution</span>
        <span class="k">return</span> <span class="n">C</span><span class="p">,</span> <span class="n">new_task_embed</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Decoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Maps target input x_target and z, r to predictions y_target.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_dim</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="n">task_dim</span><span class="p">,</span> <span class="n">h1_dim</span><span class="p">,</span> <span class="n">h2_dim</span><span class="p">,</span> <span class="n">h3_dim</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Decoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_dim</span> <span class="o">=</span> <span class="n">x_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_dim</span> <span class="o">=</span> <span class="n">z_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span> <span class="o">=</span> <span class="n">task_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h1_dim</span> <span class="o">=</span> <span class="n">h1_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h2_dim</span> <span class="o">=</span> <span class="n">h2_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h3_dim</span> <span class="o">=</span> <span class="n">h3_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_dim</span> <span class="o">=</span> <span class="n">y_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span> <span class="o">=</span> <span class="n">dropout_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layer_1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_dim</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h1_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layer_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h1_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layer_3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h2_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h3_dim</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">film_layer_1_beta</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h1_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">film_layer_1_gamma</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h1_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">film_layer_2_beta</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">film_layer_2_gamma</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">film_layer_3_beta</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h3_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">film_layer_3_gamma</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h3_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">final_projection</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h3_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_dim</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="n">interaction_size</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">interaction_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Input is concatenation of z with every row of x</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">hidden_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layer_1</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">beta_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">film_layer_1_beta</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
        <span class="n">gamma_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">film_layer_1_gamma</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
        <span class="n">hidden_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">hidden_1</span><span class="p">,</span> <span class="n">gamma_1</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta_1</span>
        <span class="n">hidden_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">hidden_1</span><span class="p">)</span>
        <span class="n">hidden_2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">hidden_1</span><span class="p">)</span>

        <span class="n">hidden_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layer_2</span><span class="p">(</span><span class="n">hidden_2</span><span class="p">)</span>
        <span class="n">beta_2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">film_layer_2_beta</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
        <span class="n">gamma_2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">film_layer_2_gamma</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
        <span class="n">hidden_2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">hidden_2</span><span class="p">,</span> <span class="n">gamma_2</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta_2</span>
        <span class="n">hidden_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">hidden_2</span><span class="p">)</span>
        <span class="n">hidden_3</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">hidden_2</span><span class="p">)</span>

        <span class="n">hidden_3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layer_3</span><span class="p">(</span><span class="n">hidden_3</span><span class="p">)</span>
        <span class="n">beta_3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">film_layer_3_beta</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
        <span class="n">gamma_3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">film_layer_3_gamma</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
        <span class="n">hidden_final</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">hidden_3</span><span class="p">,</span> <span class="n">gamma_3</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta_3</span>
        <span class="n">hidden_final</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">hidden_final</span><span class="p">)</span>
        <span class="n">hidden_final</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">hidden_final</span><span class="p">)</span>

        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_projection</span><span class="p">(</span><span class="n">hidden_final</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y_pred</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Gating_Decoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_dim</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">,</span> <span class="n">task_dim</span><span class="p">,</span> <span class="n">h1_dim</span><span class="p">,</span> <span class="n">h2_dim</span><span class="p">,</span> <span class="n">h3_dim</span><span class="p">,</span> <span class="n">y_dim</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Gating_Decoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_dim</span> <span class="o">=</span> <span class="n">x_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_dim</span> <span class="o">=</span> <span class="n">z_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span> <span class="o">=</span> <span class="n">task_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h1_dim</span> <span class="o">=</span> <span class="n">h1_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h2_dim</span> <span class="o">=</span> <span class="n">h2_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h3_dim</span> <span class="o">=</span> <span class="n">h3_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_dim</span> <span class="o">=</span> <span class="n">y_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span> <span class="o">=</span> <span class="n">dropout_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layer_1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_dim</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h1_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layer_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h1_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layer_3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h2_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h3_dim</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">film_layer_1_beta</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h1_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">film_layer_1_gamma</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h1_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">film_layer_1_eta</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h1_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">film_layer_1_delta</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h1_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">film_layer_2_beta</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">film_layer_2_gamma</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">film_layer_2_eta</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">film_layer_2_delta</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">film_layer_3_beta</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h3_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">film_layer_3_gamma</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h3_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">film_layer_3_eta</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h3_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">film_layer_3_delta</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">h3_dim</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">final_projection</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h3_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_dim</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="n">interaction_size</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">interaction_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Input is concatenation of z with every row of x</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">hidden_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layer_1</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">beta_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">film_layer_1_beta</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
        <span class="n">gamma_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">film_layer_1_gamma</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
        <span class="n">eta_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">film_layer_1_eta</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
        <span class="n">delta_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">film_layer_1_delta</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>

        <span class="n">gamma_1</span> <span class="o">=</span> <span class="n">gamma_1</span> <span class="o">*</span> <span class="n">delta_1</span> <span class="o">+</span> <span class="n">eta_1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">delta_1</span><span class="p">)</span>
        <span class="n">beta_1</span> <span class="o">=</span> <span class="n">beta_1</span> <span class="o">*</span> <span class="n">delta_1</span> <span class="o">+</span> <span class="n">eta_1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">delta_1</span><span class="p">)</span>

        <span class="n">hidden_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">hidden_1</span><span class="p">,</span> <span class="n">gamma_1</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta_1</span>
        <span class="n">hidden_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">hidden_1</span><span class="p">)</span>
        <span class="n">hidden_2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">hidden_1</span><span class="p">)</span>

        <span class="n">hidden_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layer_2</span><span class="p">(</span><span class="n">hidden_2</span><span class="p">)</span>
        <span class="n">beta_2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">film_layer_2_beta</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
        <span class="n">gamma_2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">film_layer_2_gamma</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
        <span class="n">eta_2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">film_layer_2_eta</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
        <span class="n">delta_2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">film_layer_2_delta</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>

        <span class="n">gamma_2</span> <span class="o">=</span> <span class="n">gamma_2</span> <span class="o">*</span> <span class="n">delta_2</span> <span class="o">+</span> <span class="n">eta_2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">delta_2</span><span class="p">)</span>
        <span class="n">beta_2</span> <span class="o">=</span> <span class="n">beta_2</span> <span class="o">*</span> <span class="n">delta_2</span> <span class="o">+</span> <span class="n">eta_2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">delta_2</span><span class="p">)</span>


        <span class="n">hidden_2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">hidden_2</span><span class="p">,</span> <span class="n">gamma_2</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta_2</span>
        <span class="n">hidden_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">hidden_2</span><span class="p">)</span>
        <span class="n">hidden_3</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">hidden_2</span><span class="p">)</span>
        <span class="n">hidden_3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden_layer_3</span><span class="p">(</span><span class="n">hidden_3</span><span class="p">)</span>
        <span class="n">beta_3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">film_layer_3_beta</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
        <span class="n">gamma_3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">film_layer_3_gamma</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
        <span class="n">eta_3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">film_layer_3_eta</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
        <span class="n">delta_3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">film_layer_3_delta</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>

        <span class="n">gamma_3</span> <span class="o">=</span> <span class="n">gamma_3</span> <span class="o">*</span> <span class="n">delta_3</span> <span class="o">+</span> <span class="n">eta_3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">delta_3</span><span class="p">)</span>
        <span class="n">beta_3</span> <span class="o">=</span> <span class="n">beta_3</span> <span class="o">*</span> <span class="n">delta_3</span> <span class="o">+</span> <span class="n">eta_3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">delta_3</span><span class="p">)</span>

        <span class="n">hidden_final</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">hidden_3</span><span class="p">,</span> <span class="n">gamma_3</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta_3</span>
        <span class="n">hidden_final</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">hidden_final</span><span class="p">)</span>
        <span class="n">hidden_final</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">hidden_final</span><span class="p">)</span>

        <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_projection</span><span class="p">(</span><span class="n">hidden_final</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y_pred</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="tanp">
<h3>TaNP<a class="headerlink" href="#tanp" title="Permalink to this headline">¶</a></h3>
<p><center><img src='_images/T722684_2.png'></center></p><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NP</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NP</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;second_embedding_dim&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="c1"># use one-hot or not?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_dim</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z1_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;z1_dim&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z2_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;z2_dim&#39;</span><span class="p">]</span>
        <span class="c1"># z is the dimension size of mu and sigma.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;z_dim&#39;</span><span class="p">]</span>
        <span class="c1"># the dimension size of rc.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enc_h1_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;enc_h1_dim&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enc_h2_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;enc_h2_dim&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dec_h1_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dec_h1_dim&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec_h2_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dec_h2_dim&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec_h3_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dec_h3_dim&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">taskenc_h1_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;taskenc_h1_dim&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskenc_h2_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;taskenc_h2_dim&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskenc_final_dim</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;taskenc_final_dim&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clusters_k</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;clusters_k&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperture</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dropout_rate&#39;</span><span class="p">]</span>

        <span class="c1"># Initialize networks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_emb</span> <span class="o">=</span> <span class="n">Item</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_emb</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="c1"># This encoder is used to generated z actually, it is a latent encoder in ANP.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xy_to_z</span> <span class="o">=</span> <span class="n">Encoder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">enc_h1_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">enc_h2_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z1_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z_to_mu_sigma</span> <span class="o">=</span> <span class="n">MuSigmaEncoder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z1_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z2_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_dim</span><span class="p">)</span>
        <span class="c1"># This encoder is used to generated r actually, it is a deterministic encoder in ANP.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xy_to_task</span> <span class="o">=</span> <span class="n">TaskEncoder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskenc_h1_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskenc_h2_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskenc_final_dim</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memoryunit</span> <span class="o">=</span> <span class="n">MemoryUnit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clusters_k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskenc_final_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperture</span><span class="p">)</span>
        <span class="c1">#self.xz_to_y = Gating_Decoder(self.x_dim, self.z_dim, self.taskenc_final_dim, self.dec_h1_dim, self.dec_h2_dim, self.dec_h3_dim, self.y_dim, self.dropout_rate)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xz_to_y</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">taskenc_final_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_h1_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_h2_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_h3_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout_rate</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z_i</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">z_i</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">xy_to_mu_sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c1"># Encode each point into a representation r_i</span>
        <span class="n">z_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy_to_z</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="c1"># Aggregate representations r_i into a single representation r</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">z_i</span><span class="p">)</span>
        <span class="c1"># Return parameters of distribution</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_to_mu_sigma</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

    <span class="c1"># embedding each (item, user) as the x for np</span>
    <span class="k">def</span> <span class="nf">embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">if_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_emb</span><span class="o">.</span><span class="n">feature_dim</span>
        <span class="n">item_x</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">if_dim</span><span class="p">],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">user_x</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">if_dim</span><span class="p">:],</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">item_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_emb</span><span class="p">(</span><span class="n">item_x</span><span class="p">)</span>
        <span class="n">user_emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_emb</span><span class="p">(</span><span class="n">user_x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">item_emb</span><span class="p">,</span> <span class="n">user_emb</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_context</span><span class="p">,</span> <span class="n">y_context</span><span class="p">,</span> <span class="n">x_target</span><span class="p">,</span> <span class="n">y_target</span><span class="p">):</span>
        <span class="n">x_context_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x_context</span><span class="p">)</span>
        <span class="n">x_target_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x_target</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="c1"># sigma is log_sigma actually</span>
            <span class="n">mu_target</span><span class="p">,</span> <span class="n">sigma_target</span><span class="p">,</span> <span class="n">z_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy_to_mu_sigma</span><span class="p">(</span><span class="n">x_target_embed</span><span class="p">,</span> <span class="n">y_target</span><span class="p">)</span>
            <span class="n">mu_context</span><span class="p">,</span> <span class="n">sigma_context</span><span class="p">,</span> <span class="n">z_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy_to_mu_sigma</span><span class="p">(</span><span class="n">x_context_embed</span><span class="p">,</span> <span class="n">y_context</span><span class="p">)</span>
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy_to_task</span><span class="p">(</span><span class="n">x_context_embed</span><span class="p">,</span> <span class="n">y_context</span><span class="p">)</span>
            <span class="n">mean_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="n">C_distribution</span><span class="p">,</span> <span class="n">new_task_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memoryunit</span><span class="p">(</span><span class="n">mean_task</span><span class="p">)</span>
            <span class="n">p_y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xz_to_y</span><span class="p">(</span><span class="n">x_target_embed</span><span class="p">,</span> <span class="n">z_target</span><span class="p">,</span> <span class="n">new_task_embed</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">p_y_pred</span><span class="p">,</span> <span class="n">mu_target</span><span class="p">,</span> <span class="n">sigma_target</span><span class="p">,</span> <span class="n">mu_context</span><span class="p">,</span> <span class="n">sigma_context</span><span class="p">,</span> <span class="n">C_distribution</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mu_context</span><span class="p">,</span> <span class="n">sigma_context</span><span class="p">,</span> <span class="n">z_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy_to_mu_sigma</span><span class="p">(</span><span class="n">x_context_embed</span><span class="p">,</span> <span class="n">y_context</span><span class="p">)</span>
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy_to_task</span><span class="p">(</span><span class="n">x_context_embed</span><span class="p">,</span> <span class="n">y_context</span><span class="p">)</span>
            <span class="n">mean_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="n">C_distribution</span><span class="p">,</span> <span class="n">new_task_embed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memoryunit</span><span class="p">(</span><span class="n">mean_task</span><span class="p">)</span>
            <span class="n">p_y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xz_to_y</span><span class="p">(</span><span class="n">x_target_embed</span><span class="p">,</span> <span class="n">z_context</span><span class="p">,</span> <span class="n">new_task_embed</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">p_y_pred</span>


<span class="k">class</span> <span class="nc">Trainer</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt</span> <span class="o">=</span> <span class="n">config</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Trainer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_cuda</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_cuda&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">np</span> <span class="o">=</span> <span class="n">NP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lambda</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;lambda&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">])</span>

    <span class="c1"># our kl divergence</span>
    <span class="k">def</span> <span class="nf">kl_div</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mu_target</span><span class="p">,</span> <span class="n">logsigma_target</span><span class="p">,</span> <span class="n">mu_context</span><span class="p">,</span> <span class="n">logsigma_context</span><span class="p">):</span>
        <span class="n">target_sigma</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logsigma_target</span><span class="p">)</span>
        <span class="n">context_sigma</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logsigma_context</span><span class="p">)</span>
        <span class="n">kl_div</span> <span class="o">=</span> <span class="p">(</span><span class="n">logsigma_context</span> <span class="o">-</span> <span class="n">logsigma_target</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="p">(((</span><span class="n">target_sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">mu_target</span> <span class="o">-</span> <span class="n">mu_context</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">context_sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1">#kl_div = (t.exp(posterior_var) + (posterior_mu-prior_mu) ** 2) / t.exp(prior_var) - 1. + (prior_var - posterior_var)</span>
        <span class="c1">#kl_div = 0.5 * kl_div.sum()</span>
        <span class="n">kl_div</span> <span class="o">=</span> <span class="n">kl_div</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kl_div</span>

    <span class="c1"># new kl divergence -- kl(st|sc)</span>
    <span class="k">def</span> <span class="nf">new_kl_div</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prior_mu</span><span class="p">,</span> <span class="n">prior_var</span><span class="p">,</span> <span class="n">posterior_mu</span><span class="p">,</span> <span class="n">posterior_var</span><span class="p">):</span>
        <span class="n">kl_div</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">posterior_var</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">posterior_mu</span><span class="o">-</span><span class="n">prior_mu</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">prior_var</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">+</span> <span class="p">(</span><span class="n">prior_var</span> <span class="o">-</span> <span class="n">posterior_var</span><span class="p">)</span>
        <span class="n">kl_div</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">kl_div</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kl_div</span>

    <span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_y_pred</span><span class="p">,</span> <span class="n">y_target</span><span class="p">,</span> <span class="n">mu_target</span><span class="p">,</span> <span class="n">sigma_target</span><span class="p">,</span> <span class="n">mu_context</span><span class="p">,</span> <span class="n">sigma_context</span><span class="p">):</span>
        <span class="c1">#print(&#39;p_y_pred size is &#39;, p_y_pred.size())</span>
        <span class="n">regression_loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">p_y_pred</span><span class="p">,</span> <span class="n">y_target</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1">#print(&#39;regession loss size is &#39;, regression_loss.size())</span>
        <span class="c1"># kl divergence between target and context</span>
        <span class="c1">#print(&#39;regession_loss is &#39;, regression_loss.item())</span>
        <span class="n">kl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_kl_div</span><span class="p">(</span><span class="n">mu_context</span><span class="p">,</span> <span class="n">sigma_context</span><span class="p">,</span> <span class="n">mu_target</span><span class="p">,</span> <span class="n">sigma_target</span><span class="p">)</span>
        <span class="c1">#print(&#39;KL_loss is &#39;, kl.item())</span>
        <span class="k">return</span> <span class="n">regression_loss</span><span class="o">+</span><span class="n">kl</span>

    <span class="k">def</span> <span class="nf">context_target_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">support_set_x</span><span class="p">,</span> <span class="n">support_set_y</span><span class="p">,</span> <span class="n">query_set_x</span><span class="p">,</span> <span class="n">query_set_y</span><span class="p">):</span>
        <span class="n">total_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">support_set_x</span><span class="p">,</span> <span class="n">query_set_x</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">total_y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">support_set_y</span><span class="p">,</span> <span class="n">query_set_y</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="n">total_x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">context_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;context_min&#39;</span><span class="p">]</span>
        <span class="n">context_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;context_max&#39;</span><span class="p">]</span>
        <span class="n">extra_tar_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;target_extra_min&#39;</span><span class="p">]</span>
        <span class="c1">#here we simply use the total_size as the maximum of target size.</span>
        <span class="n">num_context</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="n">context_min</span><span class="p">,</span> <span class="n">context_max</span><span class="p">)</span>
        <span class="n">num_target</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="n">extra_tar_min</span><span class="p">,</span> <span class="n">total_size</span> <span class="o">-</span> <span class="n">num_context</span><span class="p">)</span>
        <span class="n">sampled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">total_size</span><span class="p">,</span> <span class="n">num_context</span><span class="o">+</span><span class="n">num_target</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">x_context</span> <span class="o">=</span> <span class="n">total_x</span><span class="p">[</span><span class="n">sampled</span><span class="p">[:</span><span class="n">num_context</span><span class="p">],</span> <span class="p">:]</span>
        <span class="n">y_context</span> <span class="o">=</span> <span class="n">total_y</span><span class="p">[</span><span class="n">sampled</span><span class="p">[:</span><span class="n">num_context</span><span class="p">]]</span>
        <span class="n">x_target</span> <span class="o">=</span> <span class="n">total_x</span><span class="p">[</span><span class="n">sampled</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">y_target</span> <span class="o">=</span> <span class="n">total_y</span><span class="p">[</span><span class="n">sampled</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">x_context</span><span class="p">,</span> <span class="n">y_context</span><span class="p">,</span> <span class="n">x_target</span><span class="p">,</span> <span class="n">y_target</span>

    <span class="k">def</span> <span class="nf">new_context_target_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">support_set_x</span><span class="p">,</span> <span class="n">support_set_y</span><span class="p">,</span> <span class="n">query_set_x</span><span class="p">,</span> <span class="n">query_set_y</span><span class="p">):</span>
        <span class="n">total_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">support_set_x</span><span class="p">,</span> <span class="n">query_set_x</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">total_y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">support_set_y</span><span class="p">,</span> <span class="n">query_set_y</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="n">total_x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">context_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;context_min&#39;</span><span class="p">]</span>
        <span class="n">num_context</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">context_min</span><span class="p">,</span> <span class="n">total_size</span><span class="p">)</span>
        <span class="n">num_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_size</span> <span class="o">-</span> <span class="n">num_context</span><span class="p">)</span>
        <span class="n">sampled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">total_size</span><span class="p">,</span> <span class="n">num_context</span><span class="o">+</span><span class="n">num_target</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">x_context</span> <span class="o">=</span> <span class="n">total_x</span><span class="p">[</span><span class="n">sampled</span><span class="p">[:</span><span class="n">num_context</span><span class="p">],</span> <span class="p">:]</span>
        <span class="n">y_context</span> <span class="o">=</span> <span class="n">total_y</span><span class="p">[</span><span class="n">sampled</span><span class="p">[:</span><span class="n">num_context</span><span class="p">]]</span>
        <span class="n">x_target</span> <span class="o">=</span> <span class="n">total_x</span><span class="p">[</span><span class="n">sampled</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">y_target</span> <span class="o">=</span> <span class="n">total_y</span><span class="p">[</span><span class="n">sampled</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">x_context</span><span class="p">,</span> <span class="n">y_context</span><span class="p">,</span> <span class="n">x_target</span><span class="p">,</span> <span class="n">y_target</span>

    <span class="k">def</span> <span class="nf">global_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">support_set_xs</span><span class="p">,</span> <span class="n">support_set_ys</span><span class="p">,</span> <span class="n">query_set_xs</span><span class="p">,</span> <span class="n">query_set_ys</span><span class="p">):</span>
        <span class="n">batch_sz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">support_set_xs</span><span class="p">)</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">C_distribs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_cuda</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_sz</span><span class="p">):</span>
                <span class="n">support_set_xs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">support_set_xs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                <span class="n">support_set_ys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">support_set_ys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                <span class="n">query_set_xs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">query_set_xs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                <span class="n">query_set_ys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">query_set_ys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_sz</span><span class="p">):</span>
            <span class="n">x_context</span><span class="p">,</span> <span class="n">y_context</span><span class="p">,</span> <span class="n">x_target</span><span class="p">,</span> <span class="n">y_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_context_target_split</span><span class="p">(</span><span class="n">support_set_xs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">support_set_ys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                                 <span class="n">query_set_xs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">query_set_ys</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">p_y_pred</span><span class="p">,</span> <span class="n">mu_target</span><span class="p">,</span> <span class="n">sigma_target</span><span class="p">,</span> <span class="n">mu_context</span><span class="p">,</span> <span class="n">sigma_context</span><span class="p">,</span> <span class="n">C_distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="p">(</span><span class="n">x_context</span><span class="p">,</span> <span class="n">y_context</span><span class="p">,</span> <span class="n">x_target</span><span class="p">,</span>
                                                                                  <span class="n">y_target</span><span class="p">)</span>
            <span class="n">C_distribs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_distribution</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">p_y_pred</span><span class="p">,</span> <span class="n">y_target</span><span class="p">,</span> <span class="n">mu_target</span><span class="p">,</span> <span class="n">sigma_target</span><span class="p">,</span> <span class="n">mu_context</span><span class="p">,</span> <span class="n">sigma_context</span><span class="p">)</span>
            <span class="c1">#print(&#39;Each task has loss: &#39;, loss)</span>
            <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="c1"># calculate target distribution for clustering in batch manner.</span>
        <span class="c1"># batchsize * k</span>
        <span class="n">C_distribs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">C_distribs</span><span class="p">)</span>
        <span class="c1"># batchsize * k</span>
        <span class="n">C_distribs_sq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">C_distribs</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># 1*k</span>
        <span class="n">C_distribs_sum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C_distribs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># batchsize * k</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">C_distribs_sq</span> <span class="o">/</span> <span class="n">C_distribs_sum</span>
        <span class="c1"># batchsize * 1</span>
        <span class="n">temp_sum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">target_distribs</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">/</span> <span class="n">temp_sum</span>
        <span class="c1"># calculate the kl loss</span>
        <span class="n">clustering_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lambda</span> <span class="o">*</span> <span class="n">F</span><span class="o">.</span><span class="n">kl_div</span><span class="p">(</span><span class="n">C_distribs</span><span class="o">.</span><span class="n">log</span><span class="p">(),</span> <span class="n">target_distribs</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;batchmean&#39;</span><span class="p">)</span>
        <span class="c1">#print(&#39;The clustering loss is %.6f&#39; % (clustering_loss.item()))</span>
        <span class="n">np_losses_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="n">np_losses_mean</span> <span class="o">+</span> <span class="n">clustering_loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">total_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">total_loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">C_distribs</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">query_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">support_set_xs</span><span class="p">,</span> <span class="n">support_set_ys</span><span class="p">,</span> <span class="n">query_set_xs</span><span class="p">,</span> <span class="n">query_set_ys</span><span class="p">):</span>
        <span class="n">batch_sz</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># used for calculating the rmse.</span>
        <span class="n">losses_q</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_cuda</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_sz</span><span class="p">):</span>
                <span class="n">support_set_xs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">support_set_xs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                <span class="n">support_set_ys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">support_set_ys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                <span class="n">query_set_xs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">query_set_xs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
                <span class="n">query_set_ys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">query_set_ys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_sz</span><span class="p">):</span>
            <span class="c1">#query_set_y_pred = self.forward(support_set_xs[i], support_set_ys[i], query_set_xs[i], num_local_update)</span>
            <span class="n">query_set_y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">np</span><span class="p">(</span><span class="n">support_set_xs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">support_set_ys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">query_set_xs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">query_set_ys</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="c1"># obtain the mean of gaussian distribution</span>
            <span class="c1">#(interation_size, y_dim)</span>
            <span class="c1">#query_set_y_pred = query_set_y_pred.loc.detach()</span>
            <span class="c1">#print(&#39;test_y_pred size is &#39;, query_set_y_pred.size())</span>
            <span class="n">loss_q</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">query_set_y_pred</span><span class="p">,</span> <span class="n">query_set_ys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">losses_q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_q</span><span class="p">)</span>
        <span class="n">losses_q</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">losses_q</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">output_list</span><span class="p">,</span> <span class="n">recommendation_list</span> <span class="o">=</span> <span class="n">query_set_y_pred</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">losses_q</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">recommendation_list</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="evaluation-modules">
<h2>Evaluation modules<a class="headerlink" href="#evaluation-modules" title="Permalink to this headline">¶</a></h2>
<div class="section" id="metrics">
<h3>Metrics<a class="headerlink" href="#metrics" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">AP</span><span class="p">(</span><span class="n">ranked_list</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">,</span> <span class="n">topn</span><span class="p">):</span>
    <span class="n">hits</span><span class="p">,</span> <span class="n">sum_precs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ground_truth</span><span class="p">]</span>
    <span class="n">t</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">[:</span><span class="n">topn</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">topn</span><span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">ranked_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ground_truth</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">hits</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">sum_precs</span> <span class="o">+=</span> <span class="n">hits</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">hits</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sum_precs</span> <span class="o">/</span> <span class="n">topn</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

<span class="k">def</span> <span class="nf">RR</span><span class="p">(</span><span class="n">ranked_list</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">,</span><span class="n">topn</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ground_truth</span><span class="p">]</span>
    <span class="n">t</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:</span><span class="n">topn</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">topn</span><span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">ranked_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ground_truth</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">precision</span><span class="p">(</span><span class="n">ranked_list</span><span class="p">,</span><span class="n">ground_truth</span><span class="p">,</span><span class="n">topn</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ground_truth</span><span class="p">]</span>
    <span class="n">t</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:</span><span class="n">topn</span><span class="p">]</span>
    <span class="n">hits</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">topn</span><span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">ranked_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ground_truth</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">t</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span>
            <span class="n">hits</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">pre</span> <span class="o">=</span> <span class="n">hits</span><span class="o">/</span><span class="n">topn</span>
    <span class="k">return</span> <span class="n">pre</span>


<span class="k">def</span> <span class="nf">nDCG</span><span class="p">(</span><span class="n">ranked_list</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">,</span> <span class="n">topn</span><span class="p">):</span>
    <span class="n">dcg</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">idcg</span> <span class="o">=</span> <span class="n">IDCG</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">topn</span><span class="p">)</span>
    <span class="c1"># print(ranked_list)</span>
    <span class="c1"># input()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">topn</span><span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">ranked_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dcg</span> <span class="o">+=</span> <span class="p">((</span><span class="mi">2</span> <span class="o">**</span> <span class="n">ground_truth</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># print(&#39;dcg is &#39;, dcg, &quot; n is &quot;, topn)</span>
    <span class="c1"># print(&#39;idcg is &#39;, idcg, &quot; n is &quot;, topn)</span>
    <span class="k">return</span> <span class="n">dcg</span> <span class="o">/</span> <span class="n">idcg</span>

<span class="k">def</span> <span class="nf">IDCG</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span><span class="n">topn</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ground_truth</span><span class="p">]</span>
    <span class="n">t</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">idcg</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">topn</span><span class="p">):</span>
        <span class="n">idcg</span> <span class="o">+=</span> <span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">idcg</span>

<span class="k">def</span> <span class="nf">add_metric</span><span class="p">(</span><span class="n">recommend_list</span><span class="p">,</span> <span class="n">ALL_group_list</span><span class="p">,</span> <span class="n">precision_list</span><span class="p">,</span> <span class="n">ap_list</span><span class="p">,</span> <span class="n">ndcg_list</span><span class="p">,</span> <span class="n">topn</span><span class="p">):</span>
    <span class="n">ndcg</span> <span class="o">=</span> <span class="n">nDCG</span><span class="p">(</span><span class="n">recommend_list</span><span class="p">,</span> <span class="n">ALL_group_list</span><span class="p">,</span> <span class="n">topn</span><span class="p">)</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">AP</span><span class="p">(</span><span class="n">recommend_list</span><span class="p">,</span> <span class="n">ALL_group_list</span><span class="p">,</span> <span class="n">topn</span><span class="p">)</span>
    <span class="n">pre</span> <span class="o">=</span> <span class="n">precision</span><span class="p">(</span><span class="n">recommend_list</span><span class="p">,</span> <span class="n">ALL_group_list</span><span class="p">,</span> <span class="n">topn</span><span class="p">)</span>
    <span class="n">precision_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span>
    <span class="n">ap_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span>
    <span class="n">ndcg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ndcg</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">cal_metric</span><span class="p">(</span><span class="n">precision_list</span><span class="p">,</span><span class="n">ap_list</span><span class="p">,</span><span class="n">ndcg_list</span><span class="p">):</span>
    <span class="n">mpre</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">precision_list</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">precision_list</span><span class="p">)</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ap_list</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">ap_list</span><span class="p">)</span>
    <span class="n">mndcg</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ndcg_list</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndcg_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mpre</span><span class="p">,</span> <span class="n">mndcg</span><span class="p">,</span> <span class="nb">map</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="testing">
<h3>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">testing</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">):</span>
    <span class="n">test_dataset_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span>
    <span class="c1">#batch_size = opt[&quot;batch_size&quot;]</span>
    <span class="n">minibatch_size</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">test_dataset</span><span class="p">)</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">all_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pre5</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ap5</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ndcg5</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pre7</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ap7</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ndcg7</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pre10</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ap10</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ndcg10</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">test_dataset_len</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">supp_xs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">minibatch_size</span> <span class="o">*</span> <span class="n">i</span><span class="p">:</span><span class="n">minibatch_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
            <span class="n">supp_ys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">minibatch_size</span> <span class="o">*</span> <span class="n">i</span><span class="p">:</span><span class="n">minibatch_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
            <span class="n">query_xs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">minibatch_size</span> <span class="o">*</span> <span class="n">i</span><span class="p">:</span><span class="n">minibatch_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
            <span class="n">query_ys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">minibatch_size</span> <span class="o">*</span> <span class="n">i</span><span class="p">:</span><span class="n">minibatch_size</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">test_loss</span><span class="p">,</span> <span class="n">recommendation_list</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">query_rec</span><span class="p">(</span><span class="n">supp_xs</span><span class="p">,</span> <span class="n">supp_ys</span><span class="p">,</span> <span class="n">query_xs</span><span class="p">,</span> <span class="n">query_ys</span><span class="p">)</span>
        <span class="n">all_loss</span> <span class="o">+=</span> <span class="n">test_loss</span>

        <span class="n">add_metric</span><span class="p">(</span><span class="n">recommendation_list</span><span class="p">,</span> <span class="n">query_ys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">pre5</span><span class="p">,</span> <span class="n">ap5</span><span class="p">,</span> <span class="n">ndcg5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">add_metric</span><span class="p">(</span><span class="n">recommendation_list</span><span class="p">,</span> <span class="n">query_ys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">pre7</span><span class="p">,</span> <span class="n">ap7</span><span class="p">,</span> <span class="n">ndcg7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">add_metric</span><span class="p">(</span><span class="n">recommendation_list</span><span class="p">,</span> <span class="n">query_ys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">pre10</span><span class="p">,</span> <span class="n">ap10</span><span class="p">,</span> <span class="n">ndcg10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">mpre5</span><span class="p">,</span> <span class="n">mndcg5</span><span class="p">,</span> <span class="n">map5</span> <span class="o">=</span> <span class="n">cal_metric</span><span class="p">(</span><span class="n">pre5</span><span class="p">,</span> <span class="n">ap5</span><span class="p">,</span> <span class="n">ndcg5</span><span class="p">)</span>
    <span class="n">mpre7</span><span class="p">,</span> <span class="n">mndcg7</span><span class="p">,</span> <span class="n">map7</span> <span class="o">=</span> <span class="n">cal_metric</span><span class="p">(</span><span class="n">pre7</span><span class="p">,</span> <span class="n">ap7</span><span class="p">,</span> <span class="n">ndcg7</span><span class="p">)</span>
    <span class="n">mpre10</span><span class="p">,</span> <span class="n">mndcg10</span><span class="p">,</span> <span class="n">map10</span> <span class="o">=</span> <span class="n">cal_metric</span><span class="p">(</span><span class="n">pre10</span><span class="p">,</span> <span class="n">ap10</span><span class="p">,</span> <span class="n">ndcg10</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mpre5</span><span class="p">,</span> <span class="n">mndcg5</span><span class="p">,</span> <span class="n">map5</span><span class="p">,</span> <span class="n">mpre7</span><span class="p">,</span> <span class="n">mndcg7</span><span class="p">,</span> <span class="n">map7</span><span class="p">,</span> <span class="n">mpre10</span><span class="p">,</span> <span class="n">mndcg10</span><span class="p">,</span> <span class="n">map10</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="training-and-evaluation">
<h2>Training and Evaluation<a class="headerlink" href="#training-and-evaluation" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">training</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">num_epoch</span><span class="p">,</span> <span class="n">model_save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">model_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">training_set_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epoch</span><span class="p">):</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>
        <span class="n">num_batch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">training_set_size</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">train_dataset</span><span class="p">)</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">all_C_distribs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_batch</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">supp_xs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">batch_size</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="n">batch_size</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
                <span class="n">supp_ys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">batch_size</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="n">batch_size</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
                <span class="n">query_xs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">batch_size</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="n">batch_size</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
                <span class="n">query_ys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">batch_size</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="n">batch_size</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">train_loss</span><span class="p">,</span> <span class="n">batch_C_distribs</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">global_update</span><span class="p">(</span><span class="n">supp_xs</span><span class="p">,</span> <span class="n">supp_ys</span><span class="p">,</span> <span class="n">query_xs</span><span class="p">,</span> <span class="n">query_ys</span><span class="p">)</span>
            <span class="n">all_C_distribs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_C_distribs</span><span class="p">)</span>

        <span class="n">P5</span><span class="p">,</span> <span class="n">NDCG5</span><span class="p">,</span> <span class="n">MAP5</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">NDCG7</span><span class="p">,</span> <span class="n">MAP7</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">NDCG10</span><span class="p">,</span> <span class="n">MAP10</span> <span class="o">=</span> <span class="n">testing</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{:.6f}</span><span class="se">\t</span><span class="s2"> TOP-5 </span><span class="si">{:.4f}</span><span class="se">\t</span><span class="si">{:.4f}</span><span class="se">\t</span><span class="si">{:.4f}</span><span class="se">\t</span><span class="s2"> TOP-7: </span><span class="si">{:.4f}</span><span class="se">\t</span><span class="si">{:.4f}</span><span class="se">\t</span><span class="si">{:.4f}</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> TOP-10: </span><span class="si">{:.4f}</span><span class="se">\t</span><span class="si">{:.4f}</span><span class="se">\t</span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span>
                <span class="nb">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">train_loss</span><span class="p">,</span> <span class="n">P5</span><span class="p">,</span> <span class="n">NDCG5</span><span class="p">,</span> <span class="n">MAP5</span><span class="p">,</span> <span class="n">P7</span><span class="p">,</span> <span class="n">NDCG7</span><span class="p">,</span> <span class="n">MAP7</span><span class="p">,</span> <span class="n">P10</span><span class="p">,</span> <span class="n">NDCG10</span><span class="p">,</span> <span class="n">MAP10</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">==</span> <span class="p">(</span><span class="n">num_epoch</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;output_att&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">all_C_distribs</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">model_save</span><span class="p">:</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">model_filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># print model info</span>
<span class="n">print_config</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
<span class="n">ensure_dir</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;model_save_dir&quot;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># save model config</span>
<span class="n">save_config</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;model_save_dir&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.config&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># record training log</span>
<span class="n">file_logger</span> <span class="o">=</span> <span class="n">FileLogger</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;model_save_dir&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span><span class="p">,</span>
                                <span class="n">header</span><span class="o">=</span><span class="s2">&quot;# epoch</span><span class="se">\t</span><span class="s2">train_loss</span><span class="se">\t</span><span class="s2">precision5</span><span class="se">\t</span><span class="s2">NDCG5</span><span class="se">\t</span><span class="s2">MAP5</span><span class="se">\t</span><span class="s2">precision7&quot;</span>
                                       <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">NDCG7</span><span class="se">\t</span><span class="s2">MAP7</span><span class="se">\t</span><span class="s2">precision10</span><span class="se">\t</span><span class="s2">NDCG10</span><span class="se">\t</span><span class="s2">MAP10&quot;</span><span class="p">)</span>

<span class="n">preprocess</span> <span class="o">=</span> <span class="n">Preprocess</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preprocess is done.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Running with the following configs:
	data_dir : data/lastfm_20
	model_save_dir : save_model_dir
	id : 1
	first_embedding_dim : 32
	second_embedding_dim : 16
	z1_dim : 32
	z2_dim : 32
	z_dim : 32
	enc_h1_dim : 64
	enc_h2_dim : 64
	taskenc_h1_dim : 128
	taskenc_h2_dim : 64
	taskenc_final_dim : 64
	clusters_k : 7
	temperature : 1.0
	lambda : 0.1
	dec_h1_dim : 128
	dec_h2_dim : 128
	dec_h3_dim : 128
	dropout_rate : 0
	lr : 0.0001
	optim : adam
	num_epoch : 150
	batch_size : 32
	train_ratio : 0.7
	valid_ratio : 0.1
	seed : 2020
	save : 0
	use_cuda : False
	cpu : False
	support_size : 20
	query_size : 10
	max_len : 200
	context_min : 20


Directory save_model_dir do not exist; creating...
Config saved to file save_model_dir/1.config
Create training, validation and test data from scratch!
The size of total interactions is 42346.
Before delete new items in test data, test data has 8384 interactions.
After delete new items in test data, test data has 8352 interactions.
The number of total unseen interactions is 32.
Generate eposide data for training.
Generate eposide data for validation.
Generate eposide data for testing.
Preprocess is done.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Create model TaNP...&quot;</span><span class="p">)</span>

<span class="n">opt</span><span class="p">[</span><span class="s1">&#39;uf_dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preprocess</span><span class="o">.</span><span class="n">uf_dim</span>
<span class="n">opt</span><span class="p">[</span><span class="s1">&#39;if_dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">preprocess</span><span class="o">.</span><span class="n">if_dim</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

<span class="k">if</span> <span class="n">opt</span><span class="p">[</span><span class="s1">&#39;use_cuda&#39;</span><span class="p">]:</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

<span class="n">model_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">.pt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;model_save_dir&#39;</span><span class="p">],</span> <span class="n">opt</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Create model TaNP...
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># /4 since sup_x, sup_y, query_x, query_y</span>
<span class="n">training_set_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">],</span> <span class="s2">&quot;training&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">supp_xs_s</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">supp_ys_s</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">query_xs_s</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">query_ys_s</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">training_set_size</span><span class="p">):</span>
    <span class="n">supp_xs_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/supp_x_</span><span class="si">{}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">],</span> <span class="s2">&quot;training&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)))</span>
    <span class="n">supp_ys_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/supp_y_</span><span class="si">{}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">],</span> <span class="s2">&quot;training&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)))</span>
    <span class="n">query_xs_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/query_x_</span><span class="si">{}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">],</span> <span class="s2">&quot;training&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)))</span>
    <span class="n">query_ys_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/query_y_</span><span class="si">{}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">],</span> <span class="s2">&quot;training&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)))</span>

<span class="n">train_dataset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">supp_xs_s</span><span class="p">,</span> <span class="n">supp_ys_s</span><span class="p">,</span> <span class="n">query_xs_s</span><span class="p">,</span> <span class="n">query_ys_s</span><span class="p">))</span>

<span class="k">del</span> <span class="p">(</span><span class="n">supp_xs_s</span><span class="p">,</span> <span class="n">supp_ys_s</span><span class="p">,</span> <span class="n">query_xs_s</span><span class="p">,</span> <span class="n">query_ys_s</span><span class="p">)</span>

<span class="n">testing_set_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">],</span> <span class="s2">&quot;testing&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">supp_xs_s</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">supp_ys_s</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">query_xs_s</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">query_ys_s</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">testing_set_size</span><span class="p">):</span>
    <span class="n">supp_xs_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/supp_x_</span><span class="si">{}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">],</span> <span class="s2">&quot;testing&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)))</span>
    <span class="n">supp_ys_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/supp_y_</span><span class="si">{}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">],</span> <span class="s2">&quot;testing&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)))</span>
    <span class="n">query_xs_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/query_x_</span><span class="si">{}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">],</span> <span class="s2">&quot;testing&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)))</span>
    <span class="n">query_ys_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/query_y_</span><span class="si">{}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;data_dir&quot;</span><span class="p">],</span> <span class="s2">&quot;testing&quot;</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)))</span>
    
<span class="n">test_dataset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">supp_xs_s</span><span class="p">,</span> <span class="n">supp_ys_s</span><span class="p">,</span> <span class="n">query_xs_s</span><span class="p">,</span> <span class="n">query_ys_s</span><span class="p">))</span>

<span class="k">del</span> <span class="p">(</span><span class="n">supp_xs_s</span><span class="p">,</span> <span class="n">supp_ys_s</span><span class="p">,</span> <span class="n">query_xs_s</span><span class="p">,</span> <span class="n">query_ys_s</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# epoch</span><span class="se">\t</span><span class="s2">train_loss</span><span class="se">\t</span><span class="s2">precision5</span><span class="se">\t</span><span class="s2">NDCG5</span><span class="se">\t</span><span class="s2">MAP5</span><span class="se">\t</span><span class="s2">precision7</span><span class="se">\t</span><span class="s2">NDCG7</span><span class="se">\t</span><span class="s2">MAP7</span><span class="se">\t</span><span class="s2">precision10</span><span class="se">\t</span><span class="s2">NDCG10</span><span class="se">\t</span><span class="s2">MAP10&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span># epoch	train_loss	precision5	NDCG5	MAP5	precision7	NDCG7	MAP7	precision10	NDCG10	MAP10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_filename</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Start training...&quot;</span><span class="p">)</span>
    <span class="n">training</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">],</span> <span class="n">num_epoch</span><span class="o">=</span><span class="n">opt</span><span class="p">[</span><span class="s1">&#39;num_epoch&#39;</span><span class="p">],</span>
            <span class="n">model_save</span><span class="o">=</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;save&quot;</span><span class="p">],</span> <span class="n">model_filename</span><span class="o">=</span><span class="n">model_filename</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">file_logger</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load pre-trained model...&quot;</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">model_filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;config&quot;</span><span class="p">)</span>
    <span class="n">helper</span><span class="o">.</span><span class="n">print_config</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">trained_state_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_filename</span><span class="p">)</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">trained_state_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Start training...
0	1.856907	 TOP-5 0.5182	0.4987	0.4012	 TOP-7: 0.6190	0.5343	0.5179	 TOP-10: 0.8030	0.6329	0.7485
1	1.837023	 TOP-5 0.5091	0.4801	0.3818	 TOP-7: 0.6212	0.5263	0.5183	 TOP-10: 0.7939	0.6147	0.7400
2	1.818658	 TOP-5 0.5242	0.4947	0.3975	 TOP-7: 0.6299	0.5347	0.5318	 TOP-10: 0.7985	0.6228	0.7514
3	1.791948	 TOP-5 0.4970	0.4809	0.3767	 TOP-7: 0.6082	0.5217	0.5108	 TOP-10: 0.7939	0.6191	0.7437
4	1.775398	 TOP-5 0.4818	0.4545	0.3560	 TOP-7: 0.6104	0.5087	0.5027	 TOP-10: 0.7939	0.6059	0.7472
5	1.762931	 TOP-5 0.5212	0.4968	0.3906	 TOP-7: 0.6277	0.5378	0.5180	 TOP-10: 0.7955	0.6262	0.7453
6	1.733476	 TOP-5 0.5333	0.5010	0.3951	 TOP-7: 0.6234	0.5304	0.5235	 TOP-10: 0.8030	0.6239	0.7563
7	1.713983	 TOP-5 0.4939	0.4781	0.3739	 TOP-7: 0.6169	0.5306	0.5095	 TOP-10: 0.7924	0.6236	0.7406
8	1.694841	 TOP-5 0.4939	0.4639	0.3480	 TOP-7: 0.6082	0.5101	0.4925	 TOP-10: 0.7894	0.6051	0.7315
9	1.679368	 TOP-5 0.4909	0.4595	0.3587	 TOP-7: 0.6061	0.5026	0.4971	 TOP-10: 0.7879	0.5973	0.7333
10	1.650621	 TOP-5 0.5030	0.4903	0.3868	 TOP-7: 0.5866	0.5087	0.4968	 TOP-10: 0.7894	0.6180	0.7351
11	1.640563	 TOP-5 0.5061	0.5078	0.4051	 TOP-7: 0.6017	0.5328	0.5148	 TOP-10: 0.7970	0.6378	0.7486
12	1.627022	 TOP-5 0.5182	0.5047	0.4028	 TOP-7: 0.6299	0.5465	0.5292	 TOP-10: 0.7924	0.6281	0.7447
13	1.617046	 TOP-5 0.5394	0.5362	0.4354	 TOP-7: 0.6255	0.5599	0.5403	 TOP-10: 0.7985	0.6491	0.7505
14	1.613055	 TOP-5 0.5394	0.5351	0.4466	 TOP-7: 0.6212	0.5562	0.5404	 TOP-10: 0.7970	0.6457	0.7469
15	1.612253	 TOP-5 0.5394	0.5370	0.4405	 TOP-7: 0.6429	0.5728	0.5555	 TOP-10: 0.8000	0.6516	0.7547
16	1.613116	 TOP-5 0.5485	0.5417	0.4530	 TOP-7: 0.6429	0.5699	0.5576	 TOP-10: 0.8091	0.6575	0.7611
17	1.612329	 TOP-5 0.5576	0.5600	0.4641	 TOP-7: 0.6515	0.5912	0.5674	 TOP-10: 0.8030	0.6657	0.7572
18	1.612467	 TOP-5 0.5576	0.5610	0.4598	 TOP-7: 0.6407	0.5844	0.5617	 TOP-10: 0.8167	0.6786	0.7683
19	1.612230	 TOP-5 0.5515	0.5497	0.4414	 TOP-7: 0.6407	0.5791	0.5548	 TOP-10: 0.8045	0.6624	0.7570
20	1.612224	 TOP-5 0.5697	0.5723	0.4718	 TOP-7: 0.6407	0.5874	0.5588	 TOP-10: 0.8076	0.6736	0.7634
21	1.612313	 TOP-5 0.5455	0.5573	0.4510	 TOP-7: 0.6472	0.5913	0.5633	 TOP-10: 0.7985	0.6645	0.7520
22	1.612323	 TOP-5 0.5485	0.5448	0.4440	 TOP-7: 0.6429	0.5770	0.5562	 TOP-10: 0.8061	0.6610	0.7571
23	1.612233	 TOP-5 0.5788	0.5699	0.4704	 TOP-7: 0.6558	0.5905	0.5668	 TOP-10: 0.8167	0.6751	0.7727
24	1.612160	 TOP-5 0.5667	0.5725	0.4790	 TOP-7: 0.6407	0.5886	0.5616	 TOP-10: 0.8227	0.6890	0.7765
25	1.612278	 TOP-5 0.5515	0.5529	0.4595	 TOP-7: 0.6385	0.5773	0.5606	 TOP-10: 0.8061	0.6625	0.7599
26	1.612371	 TOP-5 0.5818	0.5853	0.4892	 TOP-7: 0.6342	0.5884	0.5645	 TOP-10: 0.8091	0.6801	0.7655
27	1.612172	 TOP-5 0.5697	0.5674	0.4743	 TOP-7: 0.6537	0.5932	0.5717	 TOP-10: 0.8167	0.6788	0.7705
28	1.612243	 TOP-5 0.5788	0.5821	0.4817	 TOP-7: 0.6537	0.6017	0.5716	 TOP-10: 0.8152	0.6857	0.7715
29	1.612235	 TOP-5 0.5879	0.5848	0.4862	 TOP-7: 0.6710	0.6112	0.5895	 TOP-10: 0.8152	0.6831	0.7719
30	1.612229	 TOP-5 0.5697	0.5727	0.4736	 TOP-7: 0.6602	0.6010	0.5739	 TOP-10: 0.8121	0.6794	0.7695
31	1.612226	 TOP-5 0.5970	0.5962	0.5053	 TOP-7: 0.6515	0.6009	0.5781	 TOP-10: 0.8106	0.6836	0.7712
32	1.612235	 TOP-5 0.6091	0.6046	0.5053	 TOP-7: 0.6623	0.6099	0.5878	 TOP-10: 0.8242	0.6976	0.7819
33	1.612212	 TOP-5 0.6061	0.6010	0.5144	 TOP-7: 0.6710	0.6141	0.5952	 TOP-10: 0.8167	0.6885	0.7779
34	1.612112	 TOP-5 0.5909	0.5952	0.4988	 TOP-7: 0.6688	0.6166	0.5966	 TOP-10: 0.8273	0.7019	0.7836
35	1.612202	 TOP-5 0.5970	0.6018	0.5118	 TOP-7: 0.6732	0.6229	0.6024	 TOP-10: 0.8212	0.6981	0.7809
36	1.612195	 TOP-5 0.6030	0.6049	0.5188	 TOP-7: 0.6667	0.6163	0.5949	 TOP-10: 0.8167	0.6929	0.7785
37	1.612210	 TOP-5 0.5818	0.5881	0.5002	 TOP-7: 0.6861	0.6279	0.6114	 TOP-10: 0.8273	0.7016	0.7880
38	1.612166	 TOP-5 0.6091	0.6128	0.5204	 TOP-7: 0.6883	0.6361	0.6150	 TOP-10: 0.8288	0.7090	0.7920
39	1.612114	 TOP-5 0.6121	0.6109	0.5176	 TOP-7: 0.6775	0.6247	0.6010	 TOP-10: 0.8258	0.7021	0.7854
40	1.612206	 TOP-5 0.6333	0.6283	0.5447	 TOP-7: 0.6926	0.6403	0.6210	 TOP-10: 0.8364	0.7161	0.7960
41	1.612156	 TOP-5 0.6152	0.6213	0.5299	 TOP-7: 0.6883	0.6413	0.6163	 TOP-10: 0.8394	0.7245	0.8006
42	1.612199	 TOP-5 0.6152	0.6164	0.5296	 TOP-7: 0.6926	0.6409	0.6167	 TOP-10: 0.8288	0.7102	0.7918
43	1.612141	 TOP-5 0.6333	0.6322	0.5404	 TOP-7: 0.6991	0.6478	0.6292	 TOP-10: 0.8379	0.7209	0.7999
44	1.612143	 TOP-5 0.6212	0.6242	0.5334	 TOP-7: 0.7078	0.6558	0.6322	 TOP-10: 0.8439	0.7273	0.8066
45	1.612111	 TOP-5 0.6333	0.6388	0.5510	 TOP-7: 0.7035	0.6576	0.6348	 TOP-10: 0.8409	0.7297	0.8043
46	1.612049	 TOP-5 0.6303	0.6394	0.5489	 TOP-7: 0.7078	0.6628	0.6432	 TOP-10: 0.8439	0.7331	0.8074
47	1.612166	 TOP-5 0.6394	0.6386	0.5500	 TOP-7: 0.7165	0.6641	0.6441	 TOP-10: 0.8364	0.7245	0.7994
48	1.612162	 TOP-5 0.6333	0.6355	0.5443	 TOP-7: 0.7121	0.6616	0.6367	 TOP-10: 0.8394	0.7270	0.8020
49	1.612158	 TOP-5 0.6364	0.6439	0.5566	 TOP-7: 0.7143	0.6696	0.6459	 TOP-10: 0.8318	0.7275	0.7974
50	1.612147	 TOP-5 0.6455	0.6488	0.5611	 TOP-7: 0.6991	0.6589	0.6382	 TOP-10: 0.8394	0.7320	0.8050
51	1.612150	 TOP-5 0.6545	0.6562	0.5724	 TOP-7: 0.7229	0.6768	0.6564	 TOP-10: 0.8394	0.7344	0.8060
52	1.612108	 TOP-5 0.6515	0.6605	0.5737	 TOP-7: 0.7078	0.6720	0.6473	 TOP-10: 0.8455	0.7433	0.8104
53	1.612151	 TOP-5 0.6667	0.6614	0.5781	 TOP-7: 0.7165	0.6702	0.6506	 TOP-10: 0.8394	0.7312	0.8047
54	1.612093	 TOP-5 0.6485	0.6550	0.5629	 TOP-7: 0.7078	0.6690	0.6422	 TOP-10: 0.8470	0.7427	0.8100
55	1.612118	 TOP-5 0.6515	0.6564	0.5676	 TOP-7: 0.7121	0.6701	0.6444	 TOP-10: 0.8409	0.7379	0.8043
56	1.612094	 TOP-5 0.6758	0.6830	0.5956	 TOP-7: 0.7165	0.6849	0.6605	 TOP-10: 0.8515	0.7556	0.8186
57	1.612080	 TOP-5 0.6545	0.6583	0.5745	 TOP-7: 0.7186	0.6755	0.6551	 TOP-10: 0.8561	0.7496	0.8201
58	1.612107	 TOP-5 0.6758	0.6803	0.5969	 TOP-7: 0.7143	0.6799	0.6573	 TOP-10: 0.8485	0.7510	0.8151
59	1.612218	 TOP-5 0.6788	0.6767	0.5906	 TOP-7: 0.7208	0.6804	0.6571	 TOP-10: 0.8500	0.7483	0.8165
60	1.612088	 TOP-5 0.6758	0.6804	0.5963	 TOP-7: 0.7229	0.6866	0.6654	 TOP-10: 0.8545	0.7559	0.8211
61	1.612147	 TOP-5 0.6697	0.6724	0.5879	 TOP-7: 0.7273	0.6863	0.6636	 TOP-10: 0.8530	0.7516	0.8185
62	1.612061	 TOP-5 0.6606	0.6694	0.5876	 TOP-7: 0.7165	0.6809	0.6547	 TOP-10: 0.8561	0.7563	0.8221
63	1.612108	 TOP-5 0.6848	0.6892	0.6077	 TOP-7: 0.7229	0.6892	0.6633	 TOP-10: 0.8636	0.7668	0.8286
64	1.612122	 TOP-5 0.6818	0.6831	0.5975	 TOP-7: 0.7294	0.6909	0.6655	 TOP-10: 0.8576	0.7601	0.8250
65	1.612101	 TOP-5 0.6727	0.6778	0.5936	 TOP-7: 0.7316	0.6932	0.6714	 TOP-10: 0.8530	0.7565	0.8218
66	1.612128	 TOP-5 0.6788	0.6815	0.5985	 TOP-7: 0.7316	0.6922	0.6704	 TOP-10: 0.8606	0.7610	0.8287
67	1.612063	 TOP-5 0.6788	0.6788	0.5984	 TOP-7: 0.7229	0.6837	0.6647	 TOP-10: 0.8515	0.7524	0.8202
68	1.612064	 TOP-5 0.6818	0.6866	0.6061	 TOP-7: 0.7338	0.6966	0.6736	 TOP-10: 0.8561	0.7614	0.8266
69	1.612055	 TOP-5 0.6818	0.6857	0.6053	 TOP-7: 0.7359	0.6973	0.6762	 TOP-10: 0.8606	0.7643	0.8300
70	1.612084	 TOP-5 0.6818	0.6887	0.6073	 TOP-7: 0.7338	0.6974	0.6759	 TOP-10: 0.8561	0.7624	0.8257
71	1.612110	 TOP-5 0.6879	0.6958	0.6161	 TOP-7: 0.7446	0.7087	0.6881	 TOP-10: 0.8561	0.7675	0.8264
72	1.612086	 TOP-5 0.6848	0.6901	0.6089	 TOP-7: 0.7403	0.7032	0.6795	 TOP-10: 0.8545	0.7626	0.8248
73	1.612070	 TOP-5 0.6939	0.6983	0.6164	 TOP-7: 0.7359	0.7022	0.6799	 TOP-10: 0.8606	0.7697	0.8307
74	1.612030	 TOP-5 0.7000	0.7037	0.6218	 TOP-7: 0.7468	0.7116	0.6894	 TOP-10: 0.8591	0.7704	0.8288
75	1.612020	 TOP-5 0.6939	0.6985	0.6207	 TOP-7: 0.7424	0.7066	0.6868	 TOP-10: 0.8545	0.7644	0.8242
76	1.612044	 TOP-5 0.6818	0.6945	0.6124	 TOP-7: 0.7446	0.7110	0.6859	 TOP-10: 0.8576	0.7697	0.8286
77	1.612071	 TOP-5 0.7030	0.7068	0.6229	 TOP-7: 0.7511	0.7161	0.6897	 TOP-10: 0.8561	0.7691	0.8270
78	1.612004	 TOP-5 0.6909	0.6968	0.6120	 TOP-7: 0.7468	0.7104	0.6864	 TOP-10: 0.8606	0.7695	0.8303
79	1.612048	 TOP-5 0.6939	0.7009	0.6176	 TOP-7: 0.7489	0.7138	0.6887	 TOP-10: 0.8530	0.7667	0.8248
80	1.612098	 TOP-5 0.6909	0.6992	0.6178	 TOP-7: 0.7446	0.7112	0.6888	 TOP-10: 0.8621	0.7736	0.8313
81	1.612056	 TOP-5 0.7061	0.7106	0.6255	 TOP-7: 0.7381	0.7092	0.6824	 TOP-10: 0.8576	0.7719	0.8285
82	1.612006	 TOP-5 0.6970	0.7048	0.6205	 TOP-7: 0.7424	0.7118	0.6839	 TOP-10: 0.8576	0.7710	0.8283
83	1.612046	 TOP-5 0.7000	0.7098	0.6270	 TOP-7: 0.7381	0.7113	0.6817	 TOP-10: 0.8606	0.7758	0.8300
84	1.612011	 TOP-5 0.6970	0.7057	0.6195	 TOP-7: 0.7359	0.7082	0.6782	 TOP-10: 0.8591	0.7742	0.8300
85	1.612089	 TOP-5 0.6939	0.7072	0.6214	 TOP-7: 0.7424	0.7148	0.6856	 TOP-10: 0.8591	0.7764	0.8318
86	1.612003	 TOP-5 0.6879	0.7018	0.6169	 TOP-7: 0.7381	0.7108	0.6838	 TOP-10: 0.8591	0.7743	0.8295
87	1.612035	 TOP-5 0.6909	0.7024	0.6231	 TOP-7: 0.7424	0.7118	0.6862	 TOP-10: 0.8606	0.7740	0.8315
88	1.612017	 TOP-5 0.7030	0.7080	0.6272	 TOP-7: 0.7532	0.7182	0.6963	 TOP-10: 0.8606	0.7736	0.8325
89	1.612063	 TOP-5 0.7061	0.7161	0.6340	 TOP-7: 0.7446	0.7180	0.6918	 TOP-10: 0.8606	0.7790	0.8316
90	1.612056	 TOP-5 0.7030	0.7098	0.6292	 TOP-7: 0.7511	0.7188	0.6954	 TOP-10: 0.8576	0.7728	0.8291
91	1.612038	 TOP-5 0.7182	0.7244	0.6428	 TOP-7: 0.7576	0.7279	0.7034	 TOP-10: 0.8591	0.7792	0.8324
92	1.612083	 TOP-5 0.7000	0.7140	0.6324	 TOP-7: 0.7532	0.7258	0.6986	 TOP-10: 0.8621	0.7831	0.8345
93	1.612014	 TOP-5 0.7091	0.7168	0.6393	 TOP-7: 0.7511	0.7219	0.6973	 TOP-10: 0.8636	0.7813	0.8333
94	1.612027	 TOP-5 0.7030	0.7131	0.6327	 TOP-7: 0.7641	0.7311	0.7078	 TOP-10: 0.8621	0.7805	0.8335
95	1.612071	 TOP-5 0.7061	0.7156	0.6364	 TOP-7: 0.7576	0.7268	0.7047	 TOP-10: 0.8636	0.7820	0.8350
96	1.612094	 TOP-5 0.7182	0.7241	0.6460	 TOP-7: 0.7532	0.7255	0.7020	 TOP-10: 0.8621	0.7820	0.8329
97	1.612068	 TOP-5 0.7121	0.7215	0.6470	 TOP-7: 0.7576	0.7294	0.7043	 TOP-10: 0.8636	0.7842	0.8350
98	1.612072	 TOP-5 0.7182	0.7245	0.6498	 TOP-7: 0.7489	0.7219	0.6994	 TOP-10: 0.8621	0.7804	0.8339
99	1.612078	 TOP-5 0.7182	0.7255	0.6489	 TOP-7: 0.7532	0.7259	0.7027	 TOP-10: 0.8667	0.7862	0.8375
100	1.612096	 TOP-5 0.7091	0.7193	0.6441	 TOP-7: 0.7576	0.7279	0.7058	 TOP-10: 0.8636	0.7822	0.8354
101	1.612080	 TOP-5 0.7121	0.7239	0.6489	 TOP-7: 0.7554	0.7298	0.7057	 TOP-10: 0.8636	0.7840	0.8346
102	1.612069	 TOP-5 0.7182	0.7282	0.6529	 TOP-7: 0.7511	0.7272	0.7026	 TOP-10: 0.8606	0.7820	0.8318
103	1.611941	 TOP-5 0.7121	0.7212	0.6476	 TOP-7: 0.7489	0.7227	0.7001	 TOP-10: 0.8576	0.7773	0.8290
104	1.612042	 TOP-5 0.7091	0.7211	0.6466	 TOP-7: 0.7468	0.7226	0.6998	 TOP-10: 0.8652	0.7851	0.8354
105	1.612058	 TOP-5 0.7152	0.7262	0.6494	 TOP-7: 0.7446	0.7218	0.7000	 TOP-10: 0.8636	0.7845	0.8339
106	1.612054	 TOP-5 0.7182	0.7333	0.6577	 TOP-7: 0.7468	0.7281	0.7036	 TOP-10: 0.8667	0.7918	0.8381
107	1.612006	 TOP-5 0.7212	0.7343	0.6588	 TOP-7: 0.7532	0.7323	0.7082	 TOP-10: 0.8652	0.7907	0.8365
108	1.612074	 TOP-5 0.7273	0.7365	0.6601	 TOP-7: 0.7554	0.7325	0.7102	 TOP-10: 0.8652	0.7895	0.8367
109	1.612030	 TOP-5 0.7242	0.7356	0.6587	 TOP-7: 0.7511	0.7298	0.7072	 TOP-10: 0.8621	0.7874	0.8338
110	1.612028	 TOP-5 0.7212	0.7341	0.6595	 TOP-7: 0.7511	0.7306	0.7070	 TOP-10: 0.8652	0.7904	0.8363
111	1.611958	 TOP-5 0.7212	0.7339	0.6583	 TOP-7: 0.7489	0.7291	0.7059	 TOP-10: 0.8621	0.7881	0.8342
112	1.611995	 TOP-5 0.7212	0.7323	0.6559	 TOP-7: 0.7489	0.7280	0.7032	 TOP-10: 0.8652	0.7894	0.8362
113	1.611984	 TOP-5 0.7242	0.7333	0.6585	 TOP-7: 0.7489	0.7271	0.7044	 TOP-10: 0.8606	0.7855	0.8333
114	1.612095	 TOP-5 0.7242	0.7349	0.6597	 TOP-7: 0.7446	0.7261	0.7008	 TOP-10: 0.8621	0.7881	0.8343
115	1.611942	 TOP-5 0.7273	0.7390	0.6638	 TOP-7: 0.7446	0.7275	0.7020	 TOP-10: 0.8636	0.7903	0.8345
116	1.611989	 TOP-5 0.7273	0.7384	0.6639	 TOP-7: 0.7468	0.7286	0.7057	 TOP-10: 0.8636	0.7905	0.8346
117	1.612036	 TOP-5 0.7333	0.7415	0.6686	 TOP-7: 0.7468	0.7280	0.7048	 TOP-10: 0.8652	0.7912	0.8370
118	1.611936	 TOP-5 0.7242	0.7394	0.6679	 TOP-7: 0.7489	0.7322	0.7075	 TOP-10: 0.8636	0.7931	0.8353
119	1.611901	 TOP-5 0.7303	0.7431	0.6703	 TOP-7: 0.7489	0.7321	0.7082	 TOP-10: 0.8682	0.7961	0.8380
120	1.611992	 TOP-5 0.7273	0.7422	0.6696	 TOP-7: 0.7489	0.7330	0.7076	 TOP-10: 0.8621	0.7930	0.8344
121	1.611983	 TOP-5 0.7303	0.7470	0.6741	 TOP-7: 0.7576	0.7414	0.7164	 TOP-10: 0.8621	0.7971	0.8355
122	1.612123	 TOP-5 0.7333	0.7489	0.6766	 TOP-7: 0.7576	0.7415	0.7151	 TOP-10: 0.8682	0.8013	0.8404
123	1.612018	 TOP-5 0.7273	0.7447	0.6710	 TOP-7: 0.7554	0.7400	0.7125	 TOP-10: 0.8682	0.8014	0.8401
124	1.611930	 TOP-5 0.7303	0.7456	0.6722	 TOP-7: 0.7576	0.7407	0.7149	 TOP-10: 0.8667	0.7997	0.8391
125	1.612020	 TOP-5 0.7273	0.7435	0.6694	 TOP-7: 0.7597	0.7419	0.7153	 TOP-10: 0.8697	0.8016	0.8417
126	1.611896	 TOP-5 0.7273	0.7445	0.6707	 TOP-7: 0.7597	0.7428	0.7160	 TOP-10: 0.8682	0.8015	0.8412
127	1.611954	 TOP-5 0.7303	0.7476	0.6737	 TOP-7: 0.7641	0.7463	0.7214	 TOP-10: 0.8697	0.8031	0.8429
128	1.611978	 TOP-5 0.7333	0.7511	0.6786	 TOP-7: 0.7706	0.7518	0.7264	 TOP-10: 0.8697	0.8043	0.8435
129	1.611915	 TOP-5 0.7333	0.7517	0.6794	 TOP-7: 0.7706	0.7523	0.7267	 TOP-10: 0.8712	0.8058	0.8447
130	1.611929	 TOP-5 0.7303	0.7499	0.6761	 TOP-7: 0.7706	0.7528	0.7261	 TOP-10: 0.8727	0.8067	0.8456
131	1.611872	 TOP-5 0.7303	0.7494	0.6754	 TOP-7: 0.7727	0.7538	0.7262	 TOP-10: 0.8742	0.8076	0.8474
132	1.612004	 TOP-5 0.7303	0.7492	0.6737	 TOP-7: 0.7706	0.7525	0.7257	 TOP-10: 0.8773	0.8101	0.8503
133	1.612010	 TOP-5 0.7333	0.7517	0.6757	 TOP-7: 0.7749	0.7570	0.7300	 TOP-10: 0.8758	0.8097	0.8487
134	1.611947	 TOP-5 0.7364	0.7508	0.6764	 TOP-7: 0.7727	0.7519	0.7286	 TOP-10: 0.8758	0.8067	0.8491
135	1.611911	 TOP-5 0.7333	0.7508	0.6735	 TOP-7: 0.7771	0.7575	0.7303	 TOP-10: 0.8727	0.8067	0.8468
136	1.611733	 TOP-5 0.7364	0.7510	0.6766	 TOP-7: 0.7771	0.7562	0.7322	 TOP-10: 0.8742	0.8066	0.8484
137	1.612025	 TOP-5 0.7394	0.7533	0.6796	 TOP-7: 0.7835	0.7625	0.7385	 TOP-10: 0.8742	0.8072	0.8481
138	1.611871	 TOP-5 0.7455	0.7562	0.6843	 TOP-7: 0.7814	0.7602	0.7375	 TOP-10: 0.8758	0.8074	0.8486
139	1.611889	 TOP-5 0.7424	0.7542	0.6819	 TOP-7: 0.7771	0.7574	0.7335	 TOP-10: 0.8773	0.8080	0.8497
140	1.611859	 TOP-5 0.7364	0.7506	0.6783	 TOP-7: 0.7792	0.7591	0.7348	 TOP-10: 0.8773	0.8086	0.8501
141	1.612003	 TOP-5 0.7333	0.7493	0.6765	 TOP-7: 0.7749	0.7566	0.7321	 TOP-10: 0.8788	0.8113	0.8519
142	1.611754	 TOP-5 0.7424	0.7543	0.6828	 TOP-7: 0.7771	0.7584	0.7342	 TOP-10: 0.8803	0.8121	0.8534
143	1.611885	 TOP-5 0.7485	0.7584	0.6887	 TOP-7: 0.7771	0.7577	0.7347	 TOP-10: 0.8818	0.8137	0.8554
144	1.611870	 TOP-5 0.7576	0.7660	0.6967	 TOP-7: 0.7771	0.7587	0.7348	 TOP-10: 0.8864	0.8183	0.8596
145	1.611834	 TOP-5 0.7545	0.7632	0.6927	 TOP-7: 0.7792	0.7596	0.7361	 TOP-10: 0.8879	0.8180	0.8609
146	1.611955	 TOP-5 0.7485	0.7595	0.6884	 TOP-7: 0.7814	0.7610	0.7371	 TOP-10: 0.8879	0.8181	0.8610
147	1.611880	 TOP-5 0.7485	0.7612	0.6874	 TOP-7: 0.7814	0.7629	0.7377	 TOP-10: 0.8879	0.8200	0.8612
148	1.611771	 TOP-5 0.7515	0.7644	0.6899	 TOP-7: 0.7835	0.7664	0.7407	 TOP-10: 0.8879	0.8221	0.8612
149	1.611839	 TOP-5 0.7455	0.7613	0.6851	 TOP-7: 0.7835	0.7671	0.7400	 TOP-10: 0.8879	0.8227	0.8616
</pre></div>
</div>
</div>
</div>
<p><strong>END</strong></p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "sparsh-ai/coldstart-recsys",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="T714933_MetaTL_for_Cold_start_users_on_Amazon_Electronics_dataset.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">MetaTL for Cold-start users on Amazon Electronics dataset</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="T290734_AGGN_Cold_start_Recommendation_on_ML_100k.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">AGGN Cold-start Recommendation on ML-100k</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Sparsh A.<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>